<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOBSTAR GAMES - Crypto Blackjack</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--gold:#FFB800;--gold-dim:#8a6a00;--red:#cc2200;--red-glow:#ff3300;--bg:#050505;--panel:#0d0d0d;--border:#2a1a00;--green:#00ff88;--cyan:#00e5ff;--text:#e0c88a;--text-dim:#7a6040;--white:#f5e6c8;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse at 50% 0%,rgba(200,80,0,0.12) 0%,transparent 60%),
  repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(255,180,0,0.015) 40px,rgba(255,180,0,0.015) 41px),
  repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(255,180,0,0.015) 40px,rgba(255,180,0,0.015) 41px);}

/* HEADER */
header{text-align:center;padding:16px 20px 8px;border-bottom:1px solid rgba(255,184,0,0.15);background:linear-gradient(180deg,rgba(180,60,0,0.15),transparent);}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(38px,6vw,68px);letter-spacing:6px;line-height:1;background:linear-gradient(180deg,#fff5cc,#FFB800 40%,#cc6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 20px rgba(255,120,0,0.6));}
.logo-sub{font-family:'Bebas Neue',sans-serif;font-size:clamp(13px,2vw,20px);letter-spacing:10px;color:var(--text-dim);margin-top:-4px;}
.ticker-bar{display:flex;justify-content:center;gap:24px;flex-wrap:wrap;padding:7px 0 3px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);}
.ticker-item{display:flex;gap:7px;align-items:center;}
.tv{color:var(--gold);}.tup{color:var(--green);}.tdn{color:var(--red-glow);}

/* GRID */
.main-grid{display:grid;grid-template-columns:255px 1fr 255px;gap:10px;padding:10px;max-width:1380px;margin:0 auto;}
@media(max-width:1060px){.main-grid{grid-template-columns:1fr 1fr;}.col-right{grid-column:1/-1;}}
@media(max-width:680px){.main-grid{grid-template-columns:1fr;}}

/* PANEL */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden;}
.ph{background:linear-gradient(90deg,rgba(255,184,0,0.1),rgba(255,184,0,0.04));border-bottom:1px solid var(--border);padding:7px 13px;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;color:var(--gold);display:flex;align-items:center;gap:8px;}
.ph::before{content:'';width:3px;height:11px;background:var(--gold);border-radius:1px;flex-shrink:0;}
.pb{padding:11px;}

/* SUPPLY */
.srw{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px 10px;}
.sring{position:relative;width:120px;height:120px;}
.sring svg{width:120px;height:120px;transform:rotate(-90deg);}
.rb{fill:none;stroke:rgba(255,184,0,0.1);stroke-width:8;}
.rf{fill:none;stroke:url(#rg);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.2s ease;}
.rc{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.rv{font-family:'Bebas Neue',sans-serif;font-size:24px;line-height:1;color:var(--gold);filter:drop-shadow(0 0 8px rgba(255,184,0,0.5));}
.rl{font-size:10px;color:var(--text-dim);letter-spacing:2px;}
.sstats{width:100%;display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.sbox{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.12);border-radius:3px;padding:7px;text-align:center;}
.sv{font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);}
.sl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.bflash{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red-glow);text-align:center;min-height:15px;transition:opacity 0.5s;}

/* WALLET */
.wbox{background:rgba(255,184,0,0.03);border:1px solid rgba(255,184,0,0.15);border-radius:4px;padding:11px;margin-bottom:9px;text-align:center;}
.waddr{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:3px;}
.wbal{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--gold);line-height:1;filter:drop-shadow(0 0 12px rgba(255,184,0,0.4));}
.wsub{font-size:11px;color:var(--text-dim);}
.srow{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:5px;}
.ms{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.1);border-radius:3px;padding:5px;text-align:center;}
.msv{font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);}
.msl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.pts-box{background:rgba(0,255,136,0.05);border:1px solid rgba(0,255,136,0.2);border-radius:3px;padding:8px;text-align:center;margin-top:5px;}
.pts-val{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--green);filter:drop-shadow(0 0 8px rgba(0,255,136,0.4));}
.pts-lbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;}
.btn-rst{background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-size:10px;padding:6px 12px;letter-spacing:1px;width:100%;margin-top:7px;border-radius:3px;cursor:pointer;font-family:'Bebas Neue',sans-serif;}
.btn-rst:hover{border-color:rgba(255,184,0,0.5);color:var(--gold);background:rgba(255,184,0,0.05);}

/* LEADERBOARD */
.lbwrap{max-height:260px;overflow-y:auto;}
.lbwrap::-webkit-scrollbar{width:3px;}
.lbwrap::-webkit-scrollbar-thumb{background:var(--gold-dim);}
.lbrow{display:grid;grid-template-columns:22px 1fr auto auto;gap:5px;align-items:center;padding:5px 9px;background:rgba(255,184,0,0.03);border:1px solid rgba(255,184,0,0.07);border-radius:3px;font-size:12px;margin-bottom:3px;}
.lbrow.me{border-color:rgba(255,184,0,0.3);background:rgba(255,184,0,0.08);}
.lbrnk{font-family:'Bebas Neue',sans-serif;font-size:13px;color:var(--text-dim);}
.lbrnk.g{color:#FFD700;}.lbrnk.s{color:#C0C0C0;}.lbrnk.b{color:#CD7F32;}
.lbnm{font-weight:600;color:var(--white);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lbpt{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--gold);}
.lbbr{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red-glow);}

/* TABLE */
.bjtable{background:radial-gradient(ellipse at 50% 30%,rgba(0,80,20,0.35),transparent 70%),var(--panel);border:2px solid rgba(255,184,0,0.2);border-radius:4px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;}

/* SPLIT LAYOUT */
.hands-area{display:flex;gap:10px;align-items:flex-start;}
.hand-col{flex:1;text-align:center;}
.hand-col.active-hand{background:rgba(255,184,0,0.05);border:1px solid rgba(255,184,0,0.25);border-radius:4px;padding:6px;}
.hand-col.inactive-hand{opacity:0.55;filter:grayscale(30%);}
.hand-label{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;color:var(--text-dim);margin-bottom:6px;}
.hand-label.active{color:var(--gold);}
.cards-row{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;min-height:88px;align-items:center;}
.split-vs{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--text-dim);padding-top:40px;flex-shrink:0;}

/* CARD */
.card{width:58px;height:84px;border-radius:5px;background:#fff;border:2px solid #ccc;display:flex;flex-direction:column;justify-content:space-between;padding:3px 4px;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.08);animation:cdeal .3s ease;position:relative;overflow:hidden;flex-shrink:0;}
@keyframes cdeal{from{transform:translateY(-28px) scale(0.82);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.card.red{color:#cc0000;}.card.black{color:#111;}
.card.facedown{background:linear-gradient(135deg,#1a0a00 25%,#2d1500 50%,#1a0a00 75%);border-color:var(--gold);}
.card.facedown::after{content:'‚òÖ';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:26px;color:rgba(255,184,0,0.3);}
.ct{line-height:1;}.cc{font-size:22px;text-align:center;line-height:1;}.cb{line-height:1;transform:rotate(180deg);}

.sbadge{display:inline-block;background:rgba(0,0,0,0.75);border:1px solid rgba(255,184,0,0.35);border-radius:20px;padding:2px 11px;font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);margin-top:5px;min-width:44px;text-align:center;}
.sbadge.bust{color:var(--red-glow);border-color:var(--red-glow);}
.sbadge.bj{color:var(--green);border-color:var(--green);}
.sbadge.won{color:var(--green);border-color:var(--green);}
.sbadge.lost{color:var(--red-glow);border-color:var(--red-glow);}
.sbadge.push{color:var(--gold);}

.divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,184,0,0.2),transparent);}

/* DEALER ZONE */
.dealer-zone{text-align:center;min-height:120px;}

/* BET */
.bet-area{display:flex;flex-direction:column;gap:8px;}
.bet-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);text-align:center;}
.chips-row{display:flex;justify-content:center;gap:7px;flex-wrap:wrap;}
.chip{width:44px;height:44px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:12px;cursor:pointer;transition:transform .15s,box-shadow .15s;user-select:none;}
.chip:hover{transform:scale(1.12);}.chip:active{transform:scale(0.94);}
.c100{background:radial-gradient(circle,#1a3a1a,#0d1f0d);border-color:#00cc44;color:#00cc44;box-shadow:0 0 10px rgba(0,204,68,0.3);}
.c500{background:radial-gradient(circle,#1a0d00,#0d0600);border-color:#ff6600;color:#ff6600;box-shadow:0 0 10px rgba(255,102,0,0.3);}
.c1k{background:radial-gradient(circle,#1a1500,#0d0b00);border-color:var(--gold);color:var(--gold);box-shadow:0 0 10px rgba(255,184,0,0.3);}
.c5k{background:radial-gradient(circle,#1a001a,#0d000d);border-color:#dd00ff;color:#dd00ff;box-shadow:0 0 10px rgba(221,0,255,0.3);}
.c10k{background:radial-gradient(circle,#001a1a,#000d0d);border-color:#00eeff;color:#00eeff;box-shadow:0 0 10px rgba(0,238,255,0.3);font-size:10px;}
.cclr{background:radial-gradient(circle,#1a0000,#0d0000);border-color:#ff2244;color:#ff2244;box-shadow:0 0 10px rgba(255,34,68,0.3);font-size:10px;}
.cur-bet{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--gold);}
.cur-bet span{font-size:13px;color:var(--text-dim);letter-spacing:2px;}

/* ACTION BUTTONS */
.act-row{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}
.btn{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:9px 20px;border:none;border-radius:3px;cursor:pointer;transition:all .15s;}
.btn:disabled{opacity:0.28;cursor:not-allowed;}
.bdeal{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:1px solid #ff7700;box-shadow:0 0 18px rgba(204,85,0,0.4);font-size:17px;padding:12px 34px;}
.bdeal:hover:not(:disabled){background:linear-gradient(180deg,#ee6600,#aa3300);box-shadow:0 0 28px rgba(255,100,0,0.6);}
.bhit{background:linear-gradient(180deg,#1a4020,#0d2010);color:#00ff88;border:1px solid #00aa44;}
.bhit:hover:not(:disabled){background:linear-gradient(180deg,#245530,#153020);box-shadow:0 0 14px rgba(0,255,136,0.3);}
.bstand{background:linear-gradient(180deg,#3a1a00,#200d00);color:var(--gold);border:1px solid var(--gold-dim);}
.bstand:hover:not(:disabled){box-shadow:0 0 14px rgba(255,184,0,0.3);}
.bdbl{background:linear-gradient(180deg,#200044,#100022);color:#dd88ff;border:1px solid #8800cc;}
.bdbl:hover:not(:disabled){box-shadow:0 0 14px rgba(221,136,255,0.3);}
.bsplit{background:linear-gradient(180deg,#002244,#001122);color:#00ccff;border:1px solid #0088cc;}
.bsplit:hover:not(:disabled){box-shadow:0 0 14px rgba(0,204,255,0.3);}

.result-msg{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;min-height:30px;}

/* POST-GAME OVERLAY */
.pgo{display:none;position:absolute;inset:0;z-index:20;background:rgba(0,0,0,0.91);border-radius:4px;flex-direction:column;align-items:center;justify-content:center;gap:18px;backdrop-filter:blur(5px);}
.pgo.show{display:flex;animation:pgin .3s ease;}
@keyframes pgin{from{opacity:0;transform:scale(0.94)}to{opacity:1;transform:scale(1)}}
.pgr{font-family:'Bebas Neue',sans-serif;font-size:clamp(40px,5.5vw,66px);letter-spacing:6px;text-align:center;line-height:1;}
.pgwin{color:var(--green);filter:drop-shadow(0 0 22px rgba(0,255,136,0.8));animation:pgpop .45s ease;}
.pglose{color:var(--red-glow);filter:drop-shadow(0 0 22px rgba(255,51,0,0.8));animation:pgpop .45s ease;}
.pgpush{color:var(--gold);filter:drop-shadow(0 0 14px rgba(255,184,0,0.5));}
.pgbj{color:#FFD700;filter:drop-shadow(0 0 28px rgba(255,215,0,1));animation:pgpop .45s ease;}
@keyframes pgpop{0%{transform:scale(0.55);opacity:0}65%{transform:scale(1.12)}100%{transform:scale(1);opacity:1}}
.pgd{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--text-dim);text-align:center;line-height:2.2;}
.pgd .amt{color:var(--gold);font-size:19px;}
.pgd .ptsclr{color:var(--green);font-size:15px;}
.pgd .brn{color:var(--red-glow);}
.pgd .split-results{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:4px;}
.pgd .split-hand{background:rgba(255,184,0,0.06);border:1px solid rgba(255,184,0,0.2);border-radius:4px;padding:6px 14px;text-align:center;}

.btn-next{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff9900;font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;padding:16px 60px;border-radius:4px;cursor:pointer;animation:npulse 1s ease-in-out infinite;transition:transform .15s;}
.btn-next:hover{transform:scale(1.06);box-shadow:0 0 55px rgba(255,140,0,0.7);}
@keyframes npulse{0%,100%{box-shadow:0 0 26px rgba(255,100,0,0.38);}50%{box-shadow:0 0 50px rgba(255,160,0,0.65),0 0 14px rgba(255,210,0,0.3);}}

.cdwrap{display:flex;flex-direction:column;align-items:center;gap:5px;}
.cdring{position:relative;width:46px;height:46px;}
.cdring svg{transform:rotate(-90deg);}
.cdbg{fill:none;stroke:rgba(255,184,0,0.14);stroke-width:4;}
.cdfill{fill:none;stroke:var(--gold);stroke-width:4;stroke-linecap:round;stroke-dasharray:113.1;stroke-dashoffset:0;}
.cdnum{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--gold);}
.cdlbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;}

/* TERMINAL */
.term{font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.7;height:195px;overflow-y:auto;padding:7px;background:rgba(0,0,0,0.4);}
.term::-webkit-scrollbar{width:4px;}
.term::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px;}
.tl{display:flex;gap:6px;margin-bottom:1px;}
.tts{color:var(--text-dim);flex-shrink:0;}
.tsys{color:var(--cyan);}.twin{color:var(--green);}.tlose{color:var(--red-glow);}.tburn{color:#ff6600;}.tinfo{color:var(--text);}.twarn{color:var(--gold);}.tbj{color:#FFD700;}
.tinput-row{display:flex;align-items:center;gap:6px;padding:5px 7px;border-top:1px solid rgba(255,184,0,0.1);font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);}
.tprompt{color:var(--gold);}
.tcursor{display:inline-block;width:7px;height:12px;background:var(--green);animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

@keyframes tpulse{0%{box-shadow:0 0 0 rgba(0,255,136,0);}50%{box-shadow:0 0 35px rgba(0,255,136,0.2);}100%{box-shadow:0 0 0 rgba(0,255,136,0);}}
.twin-flash{animation:tpulse .8s ease;}

/* NAME */
.noverlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.nbox{background:var(--panel);border:2px solid rgba(255,184,0,0.4);border-radius:6px;padding:30px 38px;text-align:center;max-width:390px;width:90%;box-shadow:0 0 55px rgba(255,120,0,0.3);}
.ntitle{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:4px;background:linear-gradient(180deg,#fff5cc,#FFB800,#cc6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px;}
.nsub{font-size:12px;color:var(--text-dim);margin-bottom:18px;letter-spacing:1px;}
.ninput{width:100%;background:rgba(255,184,0,0.05);border:1px solid rgba(255,184,0,0.3);border-radius:3px;padding:10px 13px;font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;color:var(--white);outline:none;text-align:center;margin-bottom:14px;}
.ninput::placeholder{color:var(--text-dim);}
.ninput:focus{border-color:var(--gold);box-shadow:0 0 14px rgba(255,184,0,0.2);}
.nenter{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:1px solid #ff7700;width:100%;font-size:17px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;padding:12px;border-radius:3px;cursor:pointer;}
.nenter:hover{background:linear-gradient(180deg,#ee6600,#aa3300);}

/* MYSTERY BOX OVERLAY */
.mbox-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.mbox-overlay.show{opacity:1;pointer-events:all;}
.mbox{background:var(--panel);border:2px solid rgba(138,43,226,0.5);border-radius:10px;padding:32px 36px;text-align:center;max-width:420px;width:92%;box-shadow:0 0 60px rgba(138,43,226,0.3);}
.mbox-icon{font-size:56px;margin-bottom:12px;animation:bounce .6s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-8px)}}
.mbox-title{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:4px;color:#cc88ff;margin-bottom:4px;}
.mbox-reward{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--gold);margin:10px 0;}
.mbox-desc{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-dim);line-height:1.7;margin-bottom:20px;}
.mbox-trigger{font-family:'Share Tech Mono',monospace;font-size:10px;color:#9955cc;letter-spacing:2px;margin-bottom:16px;}
.mbox-btn{background:linear-gradient(180deg,#6600cc,#440088);color:#fff;border:1px solid #aa44ff;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;padding:12px 40px;border-radius:4px;cursor:pointer;width:100%;}
.mbox-btn:hover{background:linear-gradient(180deg,#8800ff,#5500aa);}
.mbox-notif{position:fixed;bottom:24px;right:24px;background:rgba(138,43,226,0.9);border:1px solid #cc88ff;border-radius:8px;padding:14px 20px;font-family:'Share Tech Mono',monospace;font-size:12px;color:#fff;z-index:8000;display:none;animation:slideIn .4s ease;}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

.lbrow.bot .lbnm { color: var(--text-dim); }

/* REFERRAL */
.ref-box{background:rgba(0,255,136,0.04);border:1px solid rgba(0,255,136,0.2);border-radius:4px;padding:10px 12px;margin-top:8px;text-align:center;}
.ref-title{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;color:var(--green);margin-bottom:6px;}
.ref-link{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);background:rgba(0,0,0,0.4);border:1px solid rgba(0,255,136,0.15);border-radius:3px;padding:5px 8px;word-break:break-all;cursor:pointer;display:block;margin-bottom:6px;}
.ref-link:hover{border-color:rgba(0,255,136,0.4);color:var(--green);}
.ref-copy-btn{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:2px;padding:5px 14px;border-radius:3px;cursor:pointer;width:100%;}
.ref-copy-btn:hover{background:rgba(0,255,136,0.2);}
.ref-stats{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:6px;}
.ref-stats span{color:var(--green);}
.ref-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,255,136,0.92);color:#000;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;padding:10px 24px;border-radius:4px;z-index:9000;display:none;}
.ref-toast.show{display:block;animation:fadeup .3s ease;}
@keyframes fadeup{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
</style>
</head>
<body>

<!-- NAME OVERLAY -->
<div class="noverlay" id="nameOverlay">
  <div class="nbox">
    <div class="ntitle">LOBSTAR GAMES</div>
    <div class="nsub">ENTER YOUR X HANDLE TO PLAY</div>
    <input class="ninput" id="nameInput" placeholder="YOUR X HANDLE (e.g. @LobstarGames)" maxlength="16" autocomplete="off">
    <button class="nenter" onclick="enterGame()">ENTER THE GAME ‚òÖ</button>
  </div>
</div>

<header>
  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 20px 6px;border-bottom:1px solid rgba(255,184,0,0.12);">
    <a href="https://lobstargames.win" style="color:var(--text-dim);text-decoration:none;font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:3px;border:1px solid rgba(255,184,0,0.3);padding:7px 18px;border-radius:3px;background:rgba(255,184,0,0.04);">‚Üê HOME</a>
    <div style="text-align:center;">
      <div class="logo" style="font-size:clamp(26px,4vw,44px);line-height:1;">L‚òÖBSTAR</div>
      <div class="logo-sub" style="font-size:11px;letter-spacing:8px;margin-top:-2px;">GAMES</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <a href="https://x.com/i/communities/2026705678774178004" target="_blank" style="color:var(--text-dim);text-decoration:none;font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;border:1px solid rgba(255,184,0,0.3);padding:7px 14px;border-radius:3px;background:rgba(255,184,0,0.04);">ùïè @LOBSTARGAMES</a>
      <button onclick="shareScore()" style="color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;border:1px solid rgba(255,184,0,0.4);padding:7px 14px;border-radius:3px;background:rgba(255,184,0,0.08);cursor:pointer;">üì£ SHARE SCORE</button>
    </div>
  </div>
  <div class="ticker-bar">
    <div class="ticker-item">$LOBSTARGAMES <span class="tv" id="tkPrice">$0.0042</span> <span class="tup" id="tkChange">+18.4%</span></div>
    <div class="ticker-item">SUPPLY <span class="tv" id="tkSupply">1,000,000,000</span></div>
    <div class="ticker-item">BURNED <span class="tv tdn" id="tkBurned">0</span></div>
    <div class="ticker-item">PLAYERS <span class="tv">üî¥ LIVE</span></div>
    <div class="ticker-item">BLOCK <span class="tv" id="tkBlock">294180422</span></div>
  </div>
</header>

<div class="main-grid">
  <!-- LEFT -->
  <div class="col-left">
    <div class="panel" style="margin-bottom:10px">
      <div class="ph">TOKEN SUPPLY</div>
      <div class="srw">
        <div class="sring">
          <svg viewBox="0 0 120 120">
            <defs><linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#cc3300"/><stop offset="100%" style="stop-color:#FFB800"/></linearGradient></defs>
            <circle class="rb" cx="60" cy="60" r="52"/>
            <circle class="rf" id="ringCircle" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="0"/>
          </svg>
          <div class="rc"><div class="rv" id="ringPct">100%</div><div class="rl">REMAINING</div></div>
        </div>
        <div class="sstats">
          <div class="sbox"><div class="sv">1.00B</div><div class="sl">TOTAL</div></div>
          <div class="sbox"><div class="sv" id="statBurned" style="color:var(--red-glow)">0</div><div class="sl">BURNED ??</div></div>
          <div class="sbox"><div class="sv" id="statCirc">1.00B</div><div class="sl">CIRCULATING</div></div>
          <div class="sbox"><div class="sv" id="statHolders">147</div><div class="sl">HOLDERS</div></div>
        </div>
        <div class="bflash" id="burnFlash"></div>
      </div>
    </div>
    <div class="panel">
      <div class="ph">MY WALLET</div>
      <div class="pb">
        <div class="wbox">
          <div class="waddr" id="walletAddr">Loading...</div>
          <div class="wbal" id="walletBal">10,000</div>
          <div class="wsub">$LOBSTAR TOKENS</div>
        </div>
        <div class="srow">
          <div class="ms"><div class="msv" id="statWins">0</div><div class="msl">WINS</div></div>
          <div class="ms"><div class="msv" id="statLosses">0</div><div class="msl">LOSSES</div></div>
          <div class="ms"><div class="msv" id="statStreak">0</div><div class="msl">STREAK</div></div>
        </div>
        <div class="pts-box">
          <div class="pts-val" id="statPts">0</div>
          <div class="pts-lbl">‚òÖ TOTAL POINTS EARNED ‚òÖ</div>
        </div>
        <button class="btn-rst" onclick="resetWallet()">‚Ü∫ RESET WALLET (10,000 $LOBSTAR)</button>
      </div>
    </div>

    <!-- REFERRAL PANEL -->
    <div class="panel" id="refPanel" style="margin-top:10px;display:none">
      <div class="ph">üîó REFERRAL</div>
      <div class="pb">
        <div class="ref-box">
          <div class="ref-title">YOUR INVITE LINK</div>
          <div class="ref-link" id="refLinkText" onclick="copyRefLink()">Loading...</div>
          <button class="ref-copy-btn" onclick="copyRefLink()">üìã COPY LINK</button>
          <div class="ref-stats">FRENS REFERRED: <span id="refCount">0</span> | BONUS CHIPS: <span id="refBonus">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="col-center">
    <div class="bjtable" id="bjTable">

      <!-- POST-GAME OVERLAY -->
      <div class="pgo" id="pgOverlay">
        <div class="pgr" id="pgResult"></div>
        <div class="pgd" id="pgDetail"></div>
        <button class="btn-next" onclick="newHand()">‚ñ∂ NEXT HAND</button>
        <div class="cdwrap">
          <div class="cdring">
            <svg viewBox="0 0 46 46" width="46" height="46">
              <circle class="cdbg" cx="23" cy="23" r="18"/>
              <circle class="cdfill" id="crFill" cx="23" cy="23" r="18"/>
            </svg>
            <div class="cdnum" id="crNum">5</div>
          </div>
          <div class="cdlbl">AUTO NEXT</div>
        </div>
      </div>

      <!-- DEALER -->
      <div class="dealer-zone">
        <div class="hand-label" style="text-align:center">‚óÜ DEALER'S HAND ‚óÜ</div>
        <div class="cards-row" id="dealerCards"></div>
        <div class="sbadge" id="dealerScore">‚Äî</div>
      </div>

      <div class="divider"></div>
      <div class="result-msg" id="resultMsg"></div>
      <div class="divider"></div>

      <!-- PLAYER HANDS (single or split) -->
      <div class="hands-area" id="handsArea">
        <div class="hand-col" id="hand0col">
          <div class="hand-label" id="hand0label">‚óÜ YOUR HAND ‚óÜ</div>
          <div class="cards-row" id="hand0cards"></div>
          <div class="sbadge" id="hand0score">‚Äî</div>
        </div>
      </div>

      <!-- BET -->
      <div class="bet-area">
        <div class="bet-label">SELECT BET AMOUNT</div>
        <div class="chips-row">
          <div class="chip c100" onclick="addBet(100)">100</div>
          <div class="chip c500" onclick="addBet(500)">500</div>
          <div class="chip c1k"  onclick="addBet(1000)">1K</div>
          <div class="chip c5k"  onclick="addBet(5000)">5K</div>
          <div class="chip c10k" onclick="addBet(10000)">10K</div>
          <div class="chip cclr" onclick="clearBet()">CLR</div>
        </div>
        <div class="cur-bet"><span>BET: </span><span id="betDisplay">0</span><span> $LOBSTAR</span></div>
      </div>

      <!-- ACTIONS -->
      <div class="act-row" id="actRow">
        <button class="btn bdeal" id="btnDeal"   onclick="dealHand()">DEAL ‚òÖ</button>
        <button class="btn bhit"  id="btnHit"    onclick="playerHit()"    disabled>HIT</button>
        <button class="btn bstand" id="btnStand" onclick="playerStand()"  disabled>STAND</button>
        <button class="btn bdbl"  id="btnDouble" onclick="playerDouble()" disabled>DOUBLE</button>
        <button class="btn bsplit" id="btnSplit" onclick="playerSplit()"  disabled>SPLIT</button>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-right">
    <div class="panel" style="margin-bottom:10px">
      <div class="ph">LEADERBOARD</div>
      <div class="pb" style="padding:7px">
        <div class="lbwrap"><div id="lbList"></div></div>
      </div>
    </div>
    <div class="panel">
      <div class="ph">TERMINAL</div>
      <div class="term" id="terminal"></div>
      <div class="tinput-row"><span class="tprompt">lobstar@casino:~$</span> <span class="tcursor"></span></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const TOTAL_SUPPLY = 1_000_000_000;
const START_BAL = 10_000;
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let playerName = '', balance = START_BAL, bet = 0, deck = [];
let dealerHand = [];
// Split support: hands[0] always main, hands[1] split hand
let hands = [[]]; // array of hands
let activeHand = 0; // which hand player is currently playing
let isSplit = false;
let handResults = []; // outcome per hand
let gameState = 'betting'; // betting | playing | done
let totalBurned = 0, totalPoints = 0, wins = 0, losses = 0, streak = 0, tokenPrice = 0.0042;
let cdTimer = null;

// Leaderboard now managed by Supabase + bots ‚Äî see below

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ
const SUPA_URL = "https://mvakqyddivstvsbioptg.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo";

// ‚îÄ‚îÄ TOP 3 FIXED BOTS (always stay ahead of real players) ‚îÄ‚îÄ
const TOP_BOTS = [
  {name:'SnipeKing',  pts:84200, burned:1820000, isBot:true},
  {name:'MoonCrab',   pts:71500, burned:1540000, isBot:true},
  {name:'DegenLord',  pts:65800, burned:1200000, isBot:true},
];
// Mid-pack bots (fill gaps)
const MID_BOTS = [
  {name:'ClawMaster', pts:12300, burned:980000,  isBot:true},
  {name:'RedShell',   pts:9100,  burned:750000,  isBot:true},
  {name:'SolanaShark',pts:7700,  burned:640000,  isBot:true},
  {name:'RugnPull',   pts:5400,  burned:510000,  isBot:true},
  {name:'PumpWizard', pts:3900,  burned:340000,  isBot:true},
];

let realPlayers = []; // from Supabase
let lbReady = false;

// ‚îÄ‚îÄ Fetch real players from Supabase ‚îÄ‚îÄ
async function fetchRealPlayers() {
  try {
    const r = await fetch(`${SUPA_URL}/rest/v1/leaderboard?select=handle,pts,burned,wins,losses,games&order=pts.desc&limit=50`, {
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY
      }
    });
    if (!r.ok) return;
    const data = await r.json();
    realPlayers = data.map(p => ({
      name: p.handle,
      pts: p.pts,
      burned: p.burned || 0,
      isReal: true
    }));
  } catch(e) {
    console.log('Supabase fetch error:', e);
  }
  renderLB();
}

// ‚îÄ‚îÄ Save/update real player score ‚îÄ‚îÄ
async function saveScore() {
  if (!playerName) return;
  const payload = {
    handle: playerName,
    pts: totalPoints,
    burned: totalBurned,
    wins: wins,
    losses: losses,
    games: wins + losses,
    updated_at: new Date().toISOString()
  };
  try {
    // Try PATCH first (update existing row)
    const patch = await fetch(
      `${SUPA_URL}/rest/v1/leaderboard?handle=eq.${encodeURIComponent(playerName)}`,
      {
        method: 'PATCH',
        headers: {
          'apikey': SUPA_KEY,
          'Authorization': 'Bearer ' + SUPA_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(payload)
      }
    );
    // If no row existed (204 but nothing updated), do POST
    const text = await patch.text();
    if (patch.status === 204 || patch.ok) {
      // PATCH succeeded ‚Äî also check if row actually existed via count header
      // Simpler: always try POST with upsert header
    }
    // Use POST with upsert (on conflict update)
    await fetch(`${SUPA_URL}/rest/v1/leaderboard`, {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates,return=minimal'
      },
      body: JSON.stringify(payload)
    });
  } catch(e) {
    console.log('Supabase save error:', e);
  }
}

// ‚îÄ‚îÄ Auto-grow top bot scores so they always lead ‚îÄ‚îÄ
function growBotScores() {
  const topRealPts = realPlayers.length > 0
    ? Math.max(...realPlayers.map(p => p.pts))
    : 0;
  const myPts = totalPoints;
  const maxReal = Math.max(topRealPts, myPts);

  // Top 3 bots always stay above best real player
  if (maxReal > 0) {
    TOP_BOTS[0].pts = Math.max(TOP_BOTS[0].pts, maxReal + 15000 + Math.floor(Math.random()*2000));
    TOP_BOTS[1].pts = Math.max(TOP_BOTS[1].pts, maxReal + 8000  + Math.floor(Math.random()*1500));
    TOP_BOTS[2].pts = Math.max(TOP_BOTS[2].pts, maxReal + 3000  + Math.floor(Math.random()*1000));
  }
  // Slowly grow top bots over time
  TOP_BOTS[0].pts += Math.floor(Math.random()*400 + 100);
  TOP_BOTS[1].pts += Math.floor(Math.random()*300 + 80);
  TOP_BOTS[2].pts += Math.floor(Math.random()*200 + 60);
}

// ‚îÄ‚îÄ Fetch every 30s ‚îÄ‚îÄ
setInterval(() => { fetchRealPlayers(); growBotScores(); }, 30000);


// ‚îÄ‚îÄ ENTER ‚îÄ‚îÄ
async function enterGame() {
  const v = document.getElementById('nameInput').value.trim();
  if (!v) { document.getElementById('nameInput').focus(); return; }
  playerName = v.toUpperCase();
  localStorage.setItem('lobstar_handle', playerName);
  document.getElementById('nameOverlay').style.display = 'none';
  document.getElementById('walletAddr').textContent = '0x' + Array.from({length:8},()=>Math.floor(Math.random()*16).toString(16)).join('') + '...';

  // Load existing score from Supabase
  try {
    const r = await fetch(
      `${SUPA_URL}/rest/v1/leaderboard?handle=eq.${encodeURIComponent(playerName)}&select=pts,burned,wins,losses,games`,
      { headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY } }
    );
    const data = await r.json();
    if (data && data.length > 0) {
      const s = data[0];
      totalPoints = s.pts    || 0;
      totalBurned = s.burned || 0;
      wins        = s.wins   || 0;
      losses      = s.losses || 0;
      tlog('sys', `Welcome back, ${playerName}! Stats restored.`);
      tlog('info', `Points: ${totalPoints.toLocaleString()} | Wins: ${wins} | Losses: ${losses} | Burned: ${fmtN(totalBurned)}`);
    } else {
      // NEW player ‚Äî register referral if came via ref link
      await registerReferral(true);
      tlog('sys', `Welcome, ${playerName}. The house always burns.`);
      tlog('info', `Wallet: ${START_BAL.toLocaleString()} $LOBSTAR loaded`);
    }
  } catch(e) {
    tlog('sys', `Welcome, ${playerName}. The house always burns.`);
  }

  tlog('warn', `Min bet: 100 | SPLIT available | Every loss burns supply`);
  initReferral();
  renderLB(); fetchRealPlayers(); updateUI(); startTicker(); startBots();
}
document.getElementById('nameInput').addEventListener('keydown', e => { if(e.key==='Enter') enterGame(); });

// Auto-fill saved handle
const savedHandle = localStorage.getItem('lobstar_handle');
if (savedHandle) {
  document.getElementById('nameInput').value = savedHandle;
}

// ‚îÄ‚îÄ DECK ‚îÄ‚îÄ
function buildDeck() {
  deck = [];
  for (let s of SUITS) for (let r of RANKS) deck.push({r,s});
  for (let i=deck.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
}
const draw = () => deck.pop();
function cv(c) { if(['J','Q','K'].includes(c.r)) return 10; if(c.r==='A') return 11; return parseInt(c.r); }
function total(h) { let t=0,a=0; for(let c of h){t+=cv(c);if(c.r==='A')a++;} while(t>21&&a>0){t-=10;a--;} return t; }
const isBJ = h => h.length===2 && total(h)===21;
const hStr = h => h.map(c=>c.r+c.s).join(' ');

// ‚îÄ‚îÄ CARD RENDER ‚îÄ‚îÄ
const cc = c => (c.s==='‚ô•'||c.s==='‚ô¶') ? 'red' : 'black';
function mkCard(c, hidden=false) {
  const el = document.createElement('div');
  if (hidden) { el.className='card facedown'; return el; }
  el.className = `card ${cc(c)}`;
  el.innerHTML = `<div class="ct">${c.r}<br>${c.s}</div><div class="cc">${c.s}</div><div class="cb">${c.r}<br>${c.s}</div>`;
  return el;
}
function renderHand(elId, hand, hideSecond=false) {
  const el = document.getElementById(elId);
  el.innerHTML = '';
  hand.forEach((c,i) => el.appendChild(mkCard(c, hideSecond && i===1)));
}
function setSB(id, val, extra='') {
  const el = document.getElementById(id);
  el.textContent = val; el.className = 'sbadge' + (extra?' '+extra:'');
  if (val > 21) el.className = 'sbadge bust';
  else if (val === 21 && !extra) el.className = 'sbadge bj';
}

// ‚îÄ‚îÄ BET ‚îÄ‚îÄ
function addBet(a) {
  if (gameState !== 'betting') return;
  if (bet + a > balance) { tlog('warn','Insufficient balance.'); return; }
  bet += a; updBet();
}
function clearBet() { if (gameState !== 'betting') return; bet = 0; updBet(); }
function updBet() { document.getElementById('betDisplay').textContent = bet.toLocaleString(); }

// ‚îÄ‚îÄ DEAL ‚îÄ‚îÄ
function dealHand() {
  if (bet < 100) { tlog('warn','Minimum bet is 100 $LOBSTAR'); return; }
  if (bet > balance) { tlog('warn','Insufficient balance'); return; }
  buildDeck();
  hands = [[draw(), draw()]];
  dealerHand = [draw(), draw()];
  isSplit = false; activeHand = 0; handResults = [];
  gameState = 'playing';
  balance -= bet;
  renderDealerHand(true);
  renderAllHands();
  setSB('dealerScore', cv(dealerHand[0]));
  setSB('hand0score', total(hands[0]));
  setBtns(false, true, true, true, canSplit(hands[0]));
  document.getElementById('resultMsg').textContent = '';
  const ps = total(hands[0]);
  tlog('info', `DEAL ‚Äî Your: ${hStr(hands[0])} (${ps}) | Dealer shows: ${dealerHand[0].r}${dealerHand[0].s}`);
  if (isBJ(hands[0])) setTimeout(() => { revealDealer(); endHand('blackjack',0); }, 400);
  updateUI();
}

// ‚îÄ‚îÄ CAN SPLIT ‚îÄ‚îÄ
function canSplit(h) {
  return h.length === 2 && cv(h[0]) === cv(h[1]) && !isSplit && balance >= bet;
}

// ‚îÄ‚îÄ HIT ‚îÄ‚îÄ
function playerHit() {
  const h = hands[activeHand];
  h.push(draw());
  renderAllHands();
  const t = total(h);
  setSB(`hand${activeHand}score`, t);
  tlog('info', `HIT [Hand ${activeHand+1}] ‚Äî ${hStr(h)} = ${t}`);
  if (t > 21) setTimeout(() => endHand('bust', activeHand), 300);
  else if (t === 21) setTimeout(() => advanceHand(), 400);
  // Disable split after hit
  document.getElementById('btnSplit').disabled = true;
  document.getElementById('btnDouble').disabled = true;
}

// ‚îÄ‚îÄ STAND ‚îÄ‚îÄ
function playerStand() {
  tlog('info', `STAND [Hand ${activeHand+1}] ‚Äî ${total(hands[activeHand])}`);
  advanceHand();
}

// ‚îÄ‚îÄ DOUBLE ‚îÄ‚îÄ
function playerDouble() {
  if (bet > balance) { tlog('warn','Not enough to double'); return; }
  balance -= bet; bet *= 2; updBet(); updateUI();
  hands[activeHand].push(draw());
  renderAllHands();
  const t = total(hands[activeHand]);
  setSB(`hand${activeHand}score`, t);
  tlog('warn', `DOUBLE DOWN [Hand ${activeHand+1}] ‚Äî ${hStr(hands[activeHand])} = ${t} | Bet: ${bet.toLocaleString()}`);
  setTimeout(() => { if (t > 21) endHand('bust', activeHand); else advanceHand(); }, 400);
}

// ‚îÄ‚îÄ SPLIT ‚îÄ‚îÄ
function playerSplit() {
  if (!canSplit(hands[0])) return;
  isSplit = true;
  balance -= bet; // pay for second hand
  // Create two hands from the pair
  const c1 = hands[0][0], c2 = hands[0][1];
  hands = [[c1, draw()], [c2, draw()]];
  activeHand = 0;
  renderAllHands();
  setSB('hand0score', total(hands[0]));
  setSB('hand1score', total(hands[1]));
  tlog('warn', `SPLIT! Hand 1: ${hStr(hands[0])} | Hand 2: ${hStr(hands[1])}`);
  // Check immediate BJ on split aces
  const h0BJ = isBJ(hands[0]);
  setBtns(false, !h0BJ, !h0BJ, !h0BJ && balance>=bet*2, false);
  highlightActiveHand();
  if (h0BJ) { tlog('bj','Hand 1: BLACKJACK!'); setTimeout(() => advanceHand(), 600); }
}

// ‚îÄ‚îÄ ADVANCE HAND (after stand / bust / done) ‚îÄ‚îÄ
function advanceHand() {
  if (isSplit && activeHand === 0) {
    activeHand = 1;
    highlightActiveHand();
    const t = total(hands[1]);
    const h1BJ = isBJ(hands[1]);
    setBtns(false, !h1BJ, !h1BJ, false, false);
    if (h1BJ) { tlog('bj','Hand 2: BLACKJACK!'); setTimeout(() => { revealDealer(); runDealer(); }, 500); }
  } else {
    setBtns(false, false, false, false, false);
    revealDealer();
    runDealer();
  }
}

function highlightActiveHand() {
  if (!isSplit) return;
  document.getElementById('hand0col').className = activeHand===0 ? 'hand-col active-hand' : 'hand-col inactive-hand';
  document.getElementById('hand1col').className = activeHand===1 ? 'hand-col active-hand' : 'hand-col inactive-hand';
  document.getElementById('hand0label').className = activeHand===0 ? 'hand-label active' : 'hand-label';
  document.getElementById('hand1label').className = activeHand===1 ? 'hand-label active' : 'hand-label';
}

// ‚îÄ‚îÄ RENDER PLAYER HANDS ‚îÄ‚îÄ
function renderAllHands() {
  const area = document.getElementById('handsArea');
  if (!isSplit) {
    area.innerHTML = `
      <div class="hand-col" id="hand0col">
        <div class="hand-label" id="hand0label">‚óÜ YOUR HAND ‚óÜ</div>
        <div class="cards-row" id="hand0cards"></div>
        <div class="sbadge" id="hand0score">‚Äî</div>
      </div>`;
    renderHand('hand0cards', hands[0]);
    setSB('hand0score', total(hands[0]));
  } else {
    area.innerHTML = `
      <div class="hand-col" id="hand0col">
        <div class="hand-label" id="hand0label">‚óÜ HAND 1 ‚óÜ</div>
        <div class="cards-row" id="hand0cards"></div>
        <div class="sbadge" id="hand0score">‚Äî</div>
      </div>
      <div class="split-vs">VS</div>
      <div class="hand-col" id="hand1col">
        <div class="hand-label" id="hand1label">‚óÜ HAND 2 ‚óÜ</div>
        <div class="cards-row" id="hand1cards"></div>
        <div class="sbadge" id="hand1score">‚Äî</div>
      </div>`;
    renderHand('hand0cards', hands[0]);
    renderHand('hand1cards', hands[1]);
    setSB('hand0score', total(hands[0]));
    setSB('hand1score', total(hands[1]));
    highlightActiveHand();
  }
}

// ‚îÄ‚îÄ DEALER ‚îÄ‚îÄ
function renderDealerHand(hide=false) {
  renderHand('dealerCards', dealerHand, hide);
}
function revealDealer() {
  renderDealerHand(false);
  setSB('dealerScore', total(dealerHand));
}
function runDealer() {
  let ds = total(dealerHand);
  const step = () => {
    if (ds < 17) {
      dealerHand.push(draw());
      renderDealerHand(false);
      ds = total(dealerHand);
      setSB('dealerScore', ds);
      tlog('info', `DEALER hits ‚Äî ${hStr(dealerHand)} = ${ds}`);
      setTimeout(step, 600);
    } else {
      resolveAllHands(ds);
    }
  };
  step();
}

// ‚îÄ‚îÄ RESOLVE ‚îÄ‚îÄ
function resolveAllHands(ds) {
  if (!isSplit) {
    const ps = total(hands[0]);
    // Was already handled for bust/bj
    if (handResults[0]) { finishGame(); return; }
    if (ds > 21 || ps > ds) endHand('win', 0, ds);
    else if (ds === ps) endHand('push', 0, ds);
    else endHand('lose', 0, ds);
  } else {
    // Resolve both hands
    let pending = hands.length;
    hands.forEach((h, i) => {
      if (!handResults[i]) { // not already resolved
        const ps = total(h);
        if (ps > 21) handResults[i] = 'bust';
        else if (isBJ(h)) handResults[i] = 'blackjack';
        else if (ds > 21 || ps > ds) handResults[i] = 'win';
        else if (ds === ps) handResults[i] = 'push';
        else handResults[i] = 'lose';
      }
    });
    finishGame();
  }
}

// ‚îÄ‚îÄ END SINGLE HAND (bust/bj early) ‚îÄ‚îÄ
function endHand(outcome, handIdx, ds) {
  handResults[handIdx] = outcome;
  if (isSplit && handIdx === 0 && outcome === 'bust') {
    // continue to hand 2
    advanceHand();
    return;
  }
  if (!isSplit) finishGame();
}

// ‚îÄ‚îÄ FINISH GAME ‚îÄ‚îÄ
function finishGame() {
  gameState = 'done';
  setBtns(false,false,false,false,false);

  const ds = total(dealerHand);
  let totalWinAmt = 0, totalBurnAmt = 0, totalPtEarned = 0;
  let overallOutcome = 'lose';
  let splitDetails = [];

  const handBets = isSplit ? [bet, bet] : [bet];

  hands.forEach((h, i) => {
    const outcome = handResults[i] || 'lose';
    const hBet = handBets[i];
    let payout = 0, burnAmt = 0, ptEarned = 0, label = '';

    if (outcome === 'blackjack') {
      payout = Math.floor(hBet * 2.5);
      ptEarned = Math.floor(hBet * 1.5);
      burnAmt = Math.floor(hBet * 0.05);
      label = '‚òÖ BJ ‚òÖ';
      wins++;
    } else if (outcome === 'win') {
      payout = hBet * 2;
      ptEarned = hBet;
      burnAmt = Math.floor(hBet * 0.02);
      label = 'WIN';
      wins++;
    } else if (outcome === 'push') {
      payout = hBet;
      ptEarned = Math.floor(hBet * 0.1);
      label = 'PUSH';
    } else {
      burnAmt = hBet;
      ptEarned = Math.floor(hBet * 0.05);
      label = outcome === 'bust' ? 'BUST' : 'LOSS';
      losses++;
    }

    balance += payout;
    totalWinAmt += payout;
    totalBurnAmt += burnAmt;
    totalPtEarned += ptEarned;

    // Update hand score badge with outcome
    const badgeClass = (outcome==='win'||outcome==='blackjack') ? 'won' : (outcome==='lose'||outcome==='bust') ? 'lost' : 'push';
    setSB(`hand${i}score`, total(h) + (outcome==='bust'?' BUST':''), badgeClass);

    if (isSplit) splitDetails.push({label, payout, hBet});
  });

  // Streak
  const hadAnyWin = handResults.some(r => r==='win'||r==='blackjack');
  const hadAnyLoss = handResults.some(r => r==='lose'||r==='bust');
  if (hadAnyWin && !hadAnyLoss) {
    streak++;
    overallOutcome = handResults.includes('blackjack') ? 'blackjack' : 'win';
  } else if (hadAnyLoss && !hadAnyWin) {
    streak = 0;
    overallOutcome = handResults[0] === 'bust' ? 'bust' : 'lose';
  } else {
    overallOutcome = 'push'; // mixed split result
  }

  totalPoints += totalPtEarned;
  if (totalBurnAmt > 0) burnTokens(totalBurnAmt);
  updateLBPlayer(totalPtEarned);
  checkMboxTrigger();
  bet = 0; updBet(); updateUI();

  // Log
  if (isSplit) {
    splitDetails.forEach((d,i) => {
      tlog(d.label.includes('WIN')||d.label.includes('BJ') ? 'win' : d.label==='PUSH'?'info':'lose',
        `Hand ${i+1}: ${d.label} ‚Äî Payout: ${d.payout.toLocaleString()} $LOBSTAR`);
    });
  } else {
    const oc = handResults[0];
    if (oc==='blackjack') tlog('bj',`BLACKJACK! +${totalWinAmt.toLocaleString()} $LOBSTAR`);
    else if (oc==='win') tlog('twin',`WIN! +${totalWinAmt.toLocaleString()} $LOBSTAR | Streak: ${streak}`);
    else if (oc==='push') tlog('tinfo','PUSH ‚Äî bet returned.');
    else tlog('tlose',`${oc.toUpperCase()} ‚Äî ${totalBurnAmt.toLocaleString()} $LOBSTAR burned ??`);
  }

  // Bankruptcy
  if (balance < 100) {
    setTimeout(() => {
      balance = Math.floor(START_BAL * 0.5);
      tlog('warn',`Bankrupt! Airdrop: ${balance.toLocaleString()} $LOBSTAR`);
      updateUI();
    }, 800);
  }

  // Win flash
  if (overallOutcome==='win'||overallOutcome==='blackjack') {
    document.getElementById('bjTable').classList.add('twin-flash');
    setTimeout(()=>document.getElementById('bjTable').classList.remove('twin-flash'),900);
  }

  // Show post-game overlay
  showPostGame(overallOutcome, totalWinAmt, totalPtEarned, totalBurnAmt, splitDetails);
}

// ‚îÄ‚îÄ POST-GAME OVERLAY ‚îÄ‚îÄ
function showPostGame(outcome, winAmt, pts, burnAmt, splitDetails) {
  const labels = {blackjack:'‚òÖ BLACKJACK! ‚òÖ', win:'‚úì YOU WIN!', lose:'‚úó DEALER WINS', bust:'‚úó BUST!', push:'‚ü≥ PUSH'};
  const classes = {blackjack:'pgr pgbj', win:'pgr pgwin', lose:'pgr pglose', bust:'pgr pglose', push:'pgr pgpush'};

  document.getElementById('pgResult').className = classes[outcome] || 'pgr pglose';
  document.getElementById('pgResult').textContent = labels[outcome] || outcome.toUpperCase();

  let detail = '';
  if (isSplit && splitDetails.length > 0) {
    detail += `<div class="split-results">`;
    splitDetails.forEach((d,i) => {
      const c = (d.label.includes('WIN')||d.label.includes('BJ')) ? 'style="color:var(--green)"' : d.label==='PUSH'?'style="color:var(--gold)"':'style="color:var(--red-glow)"';
      detail += `<div class="split-hand"><div ${c}>${d.label}</div><div class="amt">${d.payout.toLocaleString()} $LOBSTAR</div></div>`;
    });
    detail += `</div>`;
  } else {
    if (winAmt > 0) detail += `<span class="amt">+${winAmt.toLocaleString()} $LOBSTAR</span><br>`;
    if (burnAmt > 0 && (outcome==='lose'||outcome==='bust')) detail += `<span class="brn">?? ${burnAmt.toLocaleString()} burned</span><br>`;
  }
  detail += `<span class="ptsclr">+${pts.toLocaleString()} POINTS EARNED</span>`;
  document.getElementById('pgDetail').innerHTML = detail;
  setTimeout(() => {
    document.getElementById('pgOverlay').classList.add('show');
    startCountdown(5);
  }, 150);
}

// ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ
function startCountdown(secs) {
  clearCountdown();
  let rem = secs;
  const fill = document.getElementById('crFill');
  const num = document.getElementById('crNum');
  const circ = 113.1;
  const tick = () => {
    num.textContent = rem;
    fill.style.strokeDashoffset = circ * (1 - rem/secs);
    if (rem <= 0) { clearCountdown(); newHand(); return; }
    rem--;
    cdTimer = setTimeout(tick, 1000);
  };
  tick();
}
function clearCountdown() { if(cdTimer){clearTimeout(cdTimer);cdTimer=null;} }

// ‚îÄ‚îÄ NEW HAND ‚îÄ‚îÄ
function newHand() {
  clearCountdown();
  // Reset state FIRST
  hands = [[]]; isSplit = false; activeHand = 0; handResults = [];
  gameState = 'betting'; bet = 0; updBet();
  // Then update DOM
  document.getElementById('pgOverlay').classList.remove('show');
  document.getElementById('dealerCards').innerHTML = '';
  document.getElementById('resultMsg').textContent = '';
  renderAllHands(); // renders clean empty hand
  setSB('dealerScore', '‚Äî');
  setSB('hand0score', '‚Äî');
  setBtns(true, false, false, false, false);
  tlog('sys','‚îÄ‚îÄ‚îÄ New hand ready. Place your bet. ‚îÄ‚îÄ‚îÄ');
}

// ‚îÄ‚îÄ RESET WALLET ‚îÄ‚îÄ
function resetWallet() {
  if(!confirm('Reset wallet to 10,000 $LOBSTAR? Stats will be cleared.')) return;
  clearCountdown();
  document.getElementById('pgOverlay').classList.remove('show');
  balance=START_BAL; wins=0; losses=0; streak=0; totalPoints=0; bet=0;
  hands=[[]]; isSplit=false; activeHand=0; handResults=[];
  updBet(); updateUI();
  document.getElementById('dealerCards').innerHTML='';
  document.getElementById('resultMsg').textContent='';
  gameState='betting'; setBtns(true,false,false,false,false);
  tlog('warn','‚Ü∫ Wallet reset ‚Äî 10,000 $LOBSTAR reloaded. Stats cleared.');
}

// ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ
function setBtns(deal,hit,stand,dbl,split) {
  document.getElementById('btnDeal').disabled = !deal;
  document.getElementById('btnHit').disabled = !hit;
  document.getElementById('btnStand').disabled = !stand;
  document.getElementById('btnDouble').disabled = !dbl;
  document.getElementById('btnSplit').disabled = !split;
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function updateUI() {
  document.getElementById('walletBal').textContent = balance.toLocaleString();
  document.getElementById('statWins').textContent = wins;
  document.getElementById('statLosses').textContent = losses;
  document.getElementById('statStreak').textContent = streak;
  document.getElementById('statPts').textContent = totalPoints.toLocaleString();
}

function fmtN(n) { if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toLocaleString(); }

// ‚îÄ‚îÄ BURN ‚îÄ‚îÄ
function burnTokens(amt) {
  totalBurned += amt;
  const pct = ((TOTAL_SUPPLY - totalBurned) / TOTAL_SUPPLY) * 100;
  document.getElementById('ringCircle').style.strokeDashoffset = 326.73 * (1 - pct/100);
  document.getElementById('ringPct').textContent = pct.toFixed(2) + '%';
  document.getElementById('statBurned').textContent = fmtN(totalBurned);
  document.getElementById('statCirc').textContent = fmtN(TOTAL_SUPPLY - totalBurned);
  document.getElementById('tkBurned').textContent = fmtN(totalBurned);
  document.getElementById('tkSupply').textContent = fmtN(TOTAL_SUPPLY - totalBurned);
  const f = document.getElementById('burnFlash');
  f.textContent = `?? BURNED ${amt.toLocaleString()} $LOBSTAR`; f.style.opacity=1;
  setTimeout(()=>f.style.opacity=0, 2200);
  tokenPrice *= (1 + amt/TOTAL_SUPPLY*15);
  document.getElementById('tkPrice').textContent = '$'+tokenPrice.toFixed(6);
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
function updateLBPlayer(pts) {
  renderLB();
  // Save to Supabase after every hand
  saveScore();
}
function renderLB() {
  growBotScores();

  // Real players minus current player
  const realNoMe = realPlayers.filter(p => p.name !== playerName);

  // Fill with mid bots if not enough real players
  const fillCount = Math.max(0, 7 - realNoMe.length);
  const fillers = MID_BOTS.slice(0, fillCount);

  // Mix real + filler bots, sort by pts
  const mid = [...realNoMe, ...fillers].sort((a,b) => b.pts - a.pts);

  // Current player entry
  const meEntry = playerName ? [{name:playerName, pts:totalPoints, burned:totalBurned, isMe:true}] : [];

  // Final: top 3 bots locked first, then mid, then insert me in correct position
  const combined = [...mid, ...meEntry].sort((a,b) => b.pts - a.pts);
  const final = [...TOP_BOTS, ...combined];

  const el = document.getElementById('lbList');
  el.innerHTML = '';
  final.slice(0, 12).forEach((p, i) => {
    const isTopBot = TOP_BOTS.some(b => b.name === p.name);
    const row = document.createElement('div');
    row.className = 'lbrow' + (p.isMe ? ' me' : '') + (isTopBot || p.isBot ? ' bot' : '');
    const rc = i===0?'g':i===1?'s':i===2?'b':'';
    const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(i+1);
    const tag = p.isMe ? ' ‚óÄ' : p.isReal ? ' üî¥' : '';
    row.innerHTML = `<div class="lbrnk ${rc}">${medal}</div><div class="lbnm">${p.name}${tag}</div><div class="lbpt">${p.pts.toLocaleString()}</div><div class="lbbr">${fmtN(p.burned)}üî•</div>`;
    el.appendChild(row);
  });
}

// ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ
function tlog(type, msg) {
  const t = document.getElementById('terminal');
  const l = document.createElement('div'); l.className='tl';
  const ts = new Date().toTimeString().slice(0,8);
  const cm = {sys:'tsys',win:'twin',lose:'tlose',burn:'tburn',info:'tinfo',warn:'twarn',bj:'tbj',twin:'twin',tinfo:'tinfo',tlose:'tlose'};
  l.innerHTML=`<span class="tts">[${ts}]</span><span class="${cm[type]||'tinfo'}">${msg}</span>`;
  t.appendChild(l); t.scrollTop=t.scrollHeight;
}

// ‚îÄ‚îÄ BOTS ‚îÄ‚îÄ
const botNames = ['SnipeKing','MoonCrab','DegenLord','ClawMaster','RedShell','SolanaShark'];
function startBots() {
  const acts = [
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];const w=Math.random()>.45;const a=(Math.floor(Math.random()*50)+5)*100;tlog(w?'win':'lose',`${n} ${w?'WIN':'LOSS'} ‚Äî ${a.toLocaleString()} $LOBSTAR`);if(!w){const b=Math.floor(a*.7);totalBurned+=b;document.getElementById('tkBurned').textContent=fmtN(totalBurned);tokenPrice*=(1+b/TOTAL_SUPPLY*8);document.getElementById('tkPrice').textContent='$'+tokenPrice.toFixed(6);}},
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];const a=(Math.floor(Math.random()*200)+10)*1000;tlog('burn',`${n} burned ${a.toLocaleString()} $LOBSTAR ??`);totalBurned+=a;document.getElementById('tkBurned').textContent=fmtN(totalBurned);},
    ()=>{const b=parseInt(document.getElementById('tkBlock').textContent.replace(/,/g,''))+1;document.getElementById('tkBlock').textContent=b.toLocaleString();tlog('sys',`Block ${b.toLocaleString()} confirmed`);},
    ()=>{const h=Math.max(100,parseInt(document.getElementById('statHolders').textContent)+Math.floor(Math.random()*3)-1);document.getElementById('statHolders').textContent=h;},
    ()=>{tlog('warn',`Large buy: ${(Math.floor(Math.random()*500)+100)*1000} $LOBSTAR`);},
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];tlog('bj',`${n} hit BLACKJACK! ??`);},
  ];
  const run = ()=>{
    acts[~~(Math.random()*acts.length)]();
    const bot=leaderboard[~~(Math.random()*(leaderboard.length-1))];
    if(bot&&!bot.isMe){bot.pts+=Math.floor(Math.random()*900+100);renderLB();}
    setTimeout(run,1600+Math.random()*2400);
  };
  setTimeout(run,2000);
}

function startTicker() {
  setInterval(()=>{
    tokenPrice=Math.max(0.00001,tokenPrice*(1+(Math.random()-.48)*.8/100));
    document.getElementById('tkPrice').textContent='$'+tokenPrice.toFixed(6);
    const d=((tokenPrice-.0042)/.0042*100);
    const el=document.getElementById('tkChange');
    el.textContent=(d>=0?'+':'')+d.toFixed(1)+'%';
    el.className=d>=0?'tup':'tdn';
  },3000);
}

// ‚îÄ‚îÄ Mystery Box ‚îÄ‚îÄ
const MBOX_REWARDS = [
  {weight:40, icon:'ü¶û', title:'LOBSTAR STASH',    reward:'1,000 $LOBSTARGAMES',  desc:'Stay claw-some! You earned a token stash.',            type:'tokens', amount:1000},
  {weight:30, icon:'‚≠ê', title:'STAR REWARD',       reward:'5,000 $LOBSTARGAMES',  desc:'Shining bright! A bigger token drop incoming.',        type:'tokens', amount:5000},
  {weight:15, icon:'üî•', title:'BURN BONUS',        reward:'10,000 $LOBSTARGAMES', desc:'You are on fire! Top tier token reward locked in.',    type:'tokens', amount:10000},
  {weight:10, icon:'üëë', title:'DEGEN ROYALE',      reward:'25,000 $LOBSTARGAMES', desc:'The claw has chosen wisely. Legendary reward.',         type:'tokens', amount:25000},
  {weight: 4, icon:'üíé', title:'DIAMOND CLAW',      reward:'50,000 $LOBSTARGAMES', desc:'Ultra rare! You just won the biggest token stash.',     type:'tokens', amount:50000},
  {weight: 1, icon:'üåô', title:'MOONSHOT',          reward:'100,000 $LOBSTARGAMES',desc:'ONE IN A HUNDRED. The lobster gods have blessed you.', type:'tokens', amount:100000},
];

function pickMboxReward() {
  const total = MBOX_REWARDS.reduce((s,r) => s+r.weight, 0);
  let roll = Math.random() * total;
  for (const r of MBOX_REWARDS) { roll -= r.weight; if (roll <= 0) return r; }
  return MBOX_REWARDS[0];
}

function triggerMbox(reason) {
  const reward = pickMboxReward();
  document.getElementById('mboxIcon').textContent = reward.icon;
  document.getElementById('mboxTrigger').textContent = reason.toUpperCase();
  document.getElementById('mboxReward').textContent = reward.reward;
  document.getElementById('mboxDesc').textContent = reward.desc;
  document.getElementById('mboxOverlay').classList.add('show');
}

function closeMbox() {
  document.getElementById('mboxOverlay').classList.remove('show');
}

function checkMboxTrigger() {
  if (streak === 3)  { setTimeout(() => triggerMbox('3 WIN STREAK!'), 800); }
  if (streak === 5)  { setTimeout(() => triggerMbox('5 WIN STREAK!'), 800); }
  if (totalPoints >= 10000  && totalPoints - wins*100 < 10000)  { setTimeout(() => triggerMbox('10,000 POINTS REACHED!'), 800); }
  if (totalPoints >= 50000  && totalPoints - wins*100 < 50000)  { setTimeout(() => triggerMbox('50,000 POINTS REACHED!'), 800); }
  if (totalPoints >= 100000 && totalPoints - wins*100 < 100000) { setTimeout(() => triggerMbox('100,000 POINTS REACHED!'), 800); }
}

// Close on overlay click
document.addEventListener('click', function(e) {
  const overlay = document.getElementById('mboxOverlay');
  if (e.target === overlay) closeMbox();
});

// ‚îÄ‚îÄ REFERRAL SYSTEM ‚îÄ‚îÄ
const REFERRAL_BONUS = 500; // chips per referral
let referredBy = null;
let myReferralCount = 0;

// Read ?ref= from URL on page load
(function() {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (ref) referredBy = ref.toUpperCase();
})();

// Show referral panel + set link after login
function initReferral() {
  const base = window.location.origin + window.location.pathname;
  const link = `${base}?ref=${encodeURIComponent(playerName)}`;
  document.getElementById('refLinkText').textContent = link;
  document.getElementById('refPanel').style.display = 'block';
  loadReferralCount();
}

// Copy link to clipboard
function copyRefLink() {
  const base = window.location.origin + window.location.pathname;
  const link = `${base}?ref=${encodeURIComponent(playerName)}`;
  navigator.clipboard.writeText(link).then(() => showRefToast('üîó LINK COPIED!'));
}

// Toast notification
function showRefToast(msg) {
  const t = document.getElementById('refToast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Load how many people this player has referred
async function loadReferralCount() {
  if (!playerName) return;
  try {
    const r = await fetch(
      `${SUPA_URL}/rest/v1/referrals?referrer=eq.${encodeURIComponent(playerName)}&select=id`,
      { headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY } }
    );
    const data = await r.json();
    myReferralCount = Array.isArray(data) ? data.length : 0;
    document.getElementById('refCount').textContent = myReferralCount;
    document.getElementById('refBonus').textContent = (myReferralCount * REFERRAL_BONUS).toLocaleString();
  } catch(e) {}
}

// Register referral ‚Äî only if:
// 1. referredBy exists in URL
// 2. This player is NEW (not in leaderboard yet)
// 3. referrer != referred (no self-referral)
async function registerReferral(isNewPlayer) {
  if (!referredBy) return;
  if (!isNewPlayer) return; // existing player ‚Äî referral doesn't apply
  if (referredBy === playerName) return; // no self-referral

  try {
    // Insert referral record ‚Äî UNIQUE(referred) prevents duplicates
    const r = await fetch(`${SUPA_URL}/rest/v1/referrals`, {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        referrer: referredBy,
        referred: playerName,
        bonus_paid: false
      })
    });

    if (r.ok || r.status === 201) {
      // Give new player bonus chips
      balance += REFERRAL_BONUS;
      updateUI();
      showRefToast(`üéÅ +${REFERRAL_BONUS} CHIPS from ${referredBy}!`);
      tlog('win', `Referred by ${referredBy} ‚Äî +${REFERRAL_BONUS} bonus chips!`);

      // Give referrer bonus points in leaderboard
      await fetch(
        `${SUPA_URL}/rest/v1/leaderboard?handle=eq.${encodeURIComponent(referredBy)}`,
        {
          method: 'PATCH',
          headers: {
            'apikey': SUPA_KEY,
            'Authorization': 'Bearer ' + SUPA_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ pts: 1000 }) // bonus pts ‚Äî NOTE: this sets pts, not adds
        }
      );
    }
  } catch(e) {
    console.log('Referral error:', e);
  }
}

// ‚îÄ‚îÄ Share Score ‚îÄ‚îÄ
function shareScore(){
  const txt = encodeURIComponent(
    'ü¶û Just played @LobstarGames!\n\n' +
    'üèÜ Points: ' + totalPoints.toLocaleString() + '\n' +
    '‚úì Wins: ' + wins + ' | ‚úó Losses: ' + losses + '\n' +
    'üî• Burned: ' + fmtN(totalBurned) + ' $LOBSTARGAMES\n\n' +
    'Every loss burns supply forever.\n' +
    'Play now üëá\nlobstargames.win/game'
  );
  window.open('https://twitter.com/intent/tweet?text=' + txt, '_blank');
}

// Init
setBtns(true,false,false,false,false);
growBotScores();
renderLB();
</script>

<!-- MYSTERY BOX OVERLAY -->
<div class="mbox-overlay" id="mboxOverlay">
  <div class="mbox">
    <div class="mbox-icon" id="mboxIcon">üéÅ</div>
    <div class="mbox-title">MYSTERY BOX</div>
    <div class="mbox-trigger" id="mboxTrigger">TRIGGERED BY STREAK</div>
    <div class="mbox-reward" id="mboxReward">??? $LOBSTARGAMES</div>
    <div class="mbox-desc" id="mboxDesc">Loading your reward...</div>
    <button class="mbox-btn" onclick="closeMbox()">CLAIM REWARD ü¶û</button>
  </div>
</div>
<div class="mbox-notif" id="mboxNotif">üéÅ Mystery Box unlocked! Check your reward!</div>
<div class="ref-toast" id="refToast"></div>
</body>
</html>
