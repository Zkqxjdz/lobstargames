<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOBSTAR GAMES - Crypto Blackjack</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--gold:#FFB800;--gold-dim:#8a6a00;--red:#cc2200;--red-glow:#ff3300;--bg:#050505;--panel:#0d0d0d;--border:#2a1a00;--green:#00ff88;--cyan:#00e5ff;--text:#e0c88a;--text-dim:#7a6040;--white:#f5e6c8;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse at 50% 0%,rgba(200,80,0,0.12) 0%,transparent 60%),
  repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(255,180,0,0.015) 40px,rgba(255,180,0,0.015) 41px),
  repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(255,180,0,0.015) 40px,rgba(255,180,0,0.015) 41px);}

/* HEADER */
header{text-align:center;padding:16px 20px 8px;border-bottom:1px solid rgba(255,184,0,0.15);background:linear-gradient(180deg,rgba(180,60,0,0.15),transparent);}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(38px,6vw,68px);letter-spacing:6px;line-height:1;background:linear-gradient(180deg,#fff5cc,#FFB800 40%,#cc6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 20px rgba(255,120,0,0.6));}
.logo-sub{font-family:'Bebas Neue',sans-serif;font-size:clamp(13px,2vw,20px);letter-spacing:10px;color:var(--text-dim);margin-top:-4px;}
.ticker-bar{display:flex;justify-content:center;gap:24px;flex-wrap:wrap;padding:7px 0 3px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);}
.ticker-item{display:flex;gap:7px;align-items:center;}
.tv{color:var(--gold);}.tup{color:var(--green);}.tdn{color:var(--red-glow);}

/* GRID */
.main-grid{display:grid;grid-template-columns:255px 1fr 255px;gap:10px;padding:10px;max-width:1380px;margin:0 auto;}
@media(max-width:1060px){.main-grid{grid-template-columns:1fr 1fr;}.col-right{grid-column:1/-1;}}
@media(max-width:680px){.main-grid{grid-template-columns:1fr;}}

/* PANEL */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden;}
.ph{background:linear-gradient(90deg,rgba(255,184,0,0.1),rgba(255,184,0,0.04));border-bottom:1px solid var(--border);padding:7px 13px;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;color:var(--gold);display:flex;align-items:center;gap:8px;}
.ph::before{content:'';width:3px;height:11px;background:var(--gold);border-radius:1px;flex-shrink:0;}
.pb{padding:11px;}

/* SUPPLY */
.srw{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px 10px;}
.sring{position:relative;width:120px;height:120px;}
.sring svg{width:120px;height:120px;transform:rotate(-90deg);}
.rb{fill:none;stroke:rgba(255,184,0,0.1);stroke-width:8;}
.rf{fill:none;stroke:url(#rg);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.2s ease;}
.rc{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.rv{font-family:'Bebas Neue',sans-serif;font-size:24px;line-height:1;color:var(--gold);filter:drop-shadow(0 0 8px rgba(255,184,0,0.5));}
.rl{font-size:10px;color:var(--text-dim);letter-spacing:2px;}
.sstats{width:100%;display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.sbox{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.12);border-radius:3px;padding:7px;text-align:center;}
.sv{font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);}
.sl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.bflash{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red-glow);text-align:center;min-height:15px;transition:opacity 0.5s;}

/* WALLET */
.wbox{background:rgba(255,184,0,0.03);border:1px solid rgba(255,184,0,0.15);border-radius:4px;padding:11px;margin-bottom:9px;text-align:center;}
.waddr{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:3px;}
.wbal{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--gold);line-height:1;filter:drop-shadow(0 0 12px rgba(255,184,0,0.4));}
.wsub{font-size:11px;color:var(--text-dim);}
.srow{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:5px;}
.ms{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.1);border-radius:3px;padding:5px;text-align:center;}
.msv{font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);}
.msl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.pts-box{background:rgba(0,255,136,0.05);border:1px solid rgba(0,255,136,0.2);border-radius:3px;padding:8px;text-align:center;margin-top:5px;}
.pts-val{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--green);filter:drop-shadow(0 0 8px rgba(0,255,136,0.4));}
.pts-lbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;}
.btn-rst{background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-size:10px;padding:6px 12px;letter-spacing:1px;width:100%;margin-top:7px;border-radius:3px;cursor:pointer;font-family:'Bebas Neue',sans-serif;}
.btn-rst:hover{border-color:rgba(255,184,0,0.5);color:var(--gold);background:rgba(255,184,0,0.05);}

/* LEADERBOARD */
.lbwrap{max-height:260px;overflow-y:auto;}
.lbwrap::-webkit-scrollbar{width:3px;}
.lbwrap::-webkit-scrollbar-thumb{background:var(--gold-dim);}
.lbrow{display:grid;grid-template-columns:22px 1fr auto auto;gap:5px;align-items:center;padding:5px 9px;background:rgba(255,184,0,0.03);border:1px solid rgba(255,184,0,0.07);border-radius:3px;font-size:12px;margin-bottom:3px;}
.lbrow.me{border-color:rgba(255,184,0,0.3);background:rgba(255,184,0,0.08);}
.lbrnk{font-family:'Bebas Neue',sans-serif;font-size:13px;color:var(--text-dim);}
.lbrnk.g{color:#FFD700;}.lbrnk.s{color:#C0C0C0;}.lbrnk.b{color:#CD7F32;}
.lbnm{font-weight:600;color:var(--white);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lbpt{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--gold);}
.lbbr{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red-glow);}

/* TABLE */
.bjtable{background:radial-gradient(ellipse at 50% 30%,rgba(0,80,20,0.35),transparent 70%),var(--panel);border:2px solid rgba(255,184,0,0.2);border-radius:4px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;}

/* SPLIT LAYOUT */
.hands-area{display:flex;gap:10px;align-items:flex-start;}
.hand-col{flex:1;text-align:center;}
.hand-col.active-hand{background:rgba(255,184,0,0.05);border:1px solid rgba(255,184,0,0.25);border-radius:4px;padding:6px;}
.hand-col.inactive-hand{opacity:0.55;filter:grayscale(30%);}
.hand-label{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;color:var(--text-dim);margin-bottom:6px;}
.hand-label.active{color:var(--gold);}
.cards-row{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;min-height:88px;align-items:center;}
.split-vs{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--text-dim);padding-top:40px;flex-shrink:0;}

/* CARD */
.card{width:58px;height:84px;border-radius:5px;background:#fff;border:2px solid #ccc;display:flex;flex-direction:column;justify-content:space-between;padding:3px 4px;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.08);animation:cdeal .3s ease;position:relative;overflow:hidden;flex-shrink:0;}
@keyframes cdeal{from{transform:translateY(-28px) scale(0.82);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.card.red{color:#cc0000;}.card.black{color:#111;}
.card.facedown{background:linear-gradient(135deg,#1a0a00 25%,#2d1500 50%,#1a0a00 75%);border-color:var(--gold);}
.card.facedown::after{content:'‚òÖ';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:26px;color:rgba(255,184,0,0.3);}
.ct{line-height:1;}.cc{font-size:22px;text-align:center;line-height:1;}.cb{line-height:1;transform:rotate(180deg);}

.sbadge{display:inline-block;background:rgba(0,0,0,0.75);border:1px solid rgba(255,184,0,0.35);border-radius:20px;padding:2px 11px;font-family:'Bebas Neue',sans-serif;font-size:17px;color:var(--gold);margin-top:5px;min-width:44px;text-align:center;}
.sbadge.bust{color:var(--red-glow);border-color:var(--red-glow);}
.sbadge.bj{color:var(--green);border-color:var(--green);}
.sbadge.won{color:var(--green);border-color:var(--green);}
.sbadge.lost{color:var(--red-glow);border-color:var(--red-glow);}
.sbadge.push{color:var(--gold);}

.divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,184,0,0.2),transparent);}

/* DEALER ZONE */
.dealer-zone{text-align:center;min-height:120px;}

/* BET */
.bet-area{display:flex;flex-direction:column;gap:8px;}
.bet-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);text-align:center;}
.chips-row{display:flex;justify-content:center;gap:7px;flex-wrap:wrap;}
.chip{width:44px;height:44px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:12px;cursor:pointer;transition:transform .15s,box-shadow .15s;user-select:none;}
.chip:hover{transform:scale(1.12);}.chip:active{transform:scale(0.94);}
.c100{background:radial-gradient(circle,#1a3a1a,#0d1f0d);border-color:#00cc44;color:#00cc44;box-shadow:0 0 10px rgba(0,204,68,0.3);}
.c500{background:radial-gradient(circle,#1a0d00,#0d0600);border-color:#ff6600;color:#ff6600;box-shadow:0 0 10px rgba(255,102,0,0.3);}
.c1k{background:radial-gradient(circle,#1a1500,#0d0b00);border-color:var(--gold);color:var(--gold);box-shadow:0 0 10px rgba(255,184,0,0.3);}
.c5k{background:radial-gradient(circle,#1a001a,#0d000d);border-color:#dd00ff;color:#dd00ff;box-shadow:0 0 10px rgba(221,0,255,0.3);}
.c10k{background:radial-gradient(circle,#001a1a,#000d0d);border-color:#00eeff;color:#00eeff;box-shadow:0 0 10px rgba(0,238,255,0.3);font-size:10px;}
.cclr{background:radial-gradient(circle,#1a0000,#0d0000);border-color:#ff2244;color:#ff2244;box-shadow:0 0 10px rgba(255,34,68,0.3);font-size:10px;}
.cur-bet{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--gold);}
.cur-bet span{font-size:13px;color:var(--text-dim);letter-spacing:2px;}

/* ACTION BUTTONS */
.act-row{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}
.btn{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:9px 20px;border:none;border-radius:3px;cursor:pointer;transition:all .15s;}
.btn:disabled{opacity:0.28;cursor:not-allowed;}
.bdeal{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:1px solid #ff7700;box-shadow:0 0 18px rgba(204,85,0,0.4);font-size:17px;padding:12px 34px;}
.bdeal:hover:not(:disabled){background:linear-gradient(180deg,#ee6600,#aa3300);box-shadow:0 0 28px rgba(255,100,0,0.6);}
.bhit{background:linear-gradient(180deg,#1a4020,#0d2010);color:#00ff88;border:1px solid #00aa44;}
.bhit:hover:not(:disabled){background:linear-gradient(180deg,#245530,#153020);box-shadow:0 0 14px rgba(0,255,136,0.3);}
.bstand{background:linear-gradient(180deg,#3a1a00,#200d00);color:var(--gold);border:1px solid var(--gold-dim);}
.bstand:hover:not(:disabled){box-shadow:0 0 14px rgba(255,184,0,0.3);}
.bdbl{background:linear-gradient(180deg,#200044,#100022);color:#dd88ff;border:1px solid #8800cc;}
.bdbl:hover:not(:disabled){box-shadow:0 0 14px rgba(221,136,255,0.3);}
.bsplit{background:linear-gradient(180deg,#002244,#001122);color:#00ccff;border:1px solid #0088cc;}
.bsplit:hover:not(:disabled){box-shadow:0 0 14px rgba(0,204,255,0.3);}

.result-msg{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;min-height:30px;}

/* POST-GAME OVERLAY */
.pgo{display:none;position:absolute;inset:0;z-index:20;background:rgba(0,0,0,0.91);border-radius:4px;flex-direction:column;align-items:center;justify-content:center;gap:18px;backdrop-filter:blur(5px);}
.pgo.show{display:flex;animation:pgin .3s ease;}
@keyframes pgin{from{opacity:0;transform:scale(0.94)}to{opacity:1;transform:scale(1)}}
.pgr{font-family:'Bebas Neue',sans-serif;font-size:clamp(40px,5.5vw,66px);letter-spacing:6px;text-align:center;line-height:1;}
.pgwin{color:var(--green);filter:drop-shadow(0 0 22px rgba(0,255,136,0.8));animation:pgpop .45s ease;}
.pglose{color:var(--red-glow);filter:drop-shadow(0 0 22px rgba(255,51,0,0.8));animation:pgpop .45s ease;}
.pgpush{color:var(--gold);filter:drop-shadow(0 0 14px rgba(255,184,0,0.5));}
.pgbj{color:#FFD700;filter:drop-shadow(0 0 28px rgba(255,215,0,1));animation:pgpop .45s ease;}
@keyframes pgpop{0%{transform:scale(0.55);opacity:0}65%{transform:scale(1.12)}100%{transform:scale(1);opacity:1}}
.pgd{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--text-dim);text-align:center;line-height:2.2;}
.pgd .amt{color:var(--gold);font-size:19px;}
.pgd .ptsclr{color:var(--green);font-size:15px;}
.pgd .brn{color:var(--red-glow);}
.pgd .split-results{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:4px;}
.pgd .split-hand{background:rgba(255,184,0,0.06);border:1px solid rgba(255,184,0,0.2);border-radius:4px;padding:6px 14px;text-align:center;}

.btn-next{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff9900;font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;padding:16px 60px;border-radius:4px;cursor:pointer;animation:npulse 1s ease-in-out infinite;transition:transform .15s;}
.btn-next:hover{transform:scale(1.06);box-shadow:0 0 55px rgba(255,140,0,0.7);}
@keyframes npulse{0%,100%{box-shadow:0 0 26px rgba(255,100,0,0.38);}50%{box-shadow:0 0 50px rgba(255,160,0,0.65),0 0 14px rgba(255,210,0,0.3);}}

.cdwrap{display:flex;flex-direction:column;align-items:center;gap:5px;}
.cdring{position:relative;width:46px;height:46px;}
.cdring svg{transform:rotate(-90deg);}
.cdbg{fill:none;stroke:rgba(255,184,0,0.14);stroke-width:4;}
.cdfill{fill:none;stroke:var(--gold);stroke-width:4;stroke-linecap:round;stroke-dasharray:113.1;stroke-dashoffset:0;}
.cdnum{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--gold);}
.cdlbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;}

/* TERMINAL */
.term{font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.7;height:195px;overflow-y:auto;padding:7px;background:rgba(0,0,0,0.4);}
.term::-webkit-scrollbar{width:4px;}
.term::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px;}
.tl{display:flex;gap:6px;margin-bottom:1px;}
.tts{color:var(--text-dim);flex-shrink:0;}
.tsys{color:var(--cyan);}.twin{color:var(--green);}.tlose{color:var(--red-glow);}.tburn{color:#ff6600;}.tinfo{color:var(--text);}.twarn{color:var(--gold);}.tbj{color:#FFD700;}
.tinput-row{display:flex;align-items:center;gap:6px;padding:5px 7px;border-top:1px solid rgba(255,184,0,0.1);font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);}
.tprompt{color:var(--gold);}
.tcursor{display:inline-block;width:7px;height:12px;background:var(--green);animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

@keyframes tpulse{0%{box-shadow:0 0 0 rgba(0,255,136,0);}50%{box-shadow:0 0 35px rgba(0,255,136,0.2);}100%{box-shadow:0 0 0 rgba(0,255,136,0);}}
.twin-flash{animation:tpulse .8s ease;}

/* NAME */
.noverlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.nbox{background:var(--panel);border:2px solid rgba(255,184,0,0.4);border-radius:6px;padding:30px 38px;text-align:center;max-width:390px;width:90%;box-shadow:0 0 55px rgba(255,120,0,0.3);}
.ntitle{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:4px;background:linear-gradient(180deg,#fff5cc,#FFB800,#cc6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px;}
.nsub{font-size:12px;color:var(--text-dim);margin-bottom:18px;letter-spacing:1px;}
.ninput{width:100%;background:rgba(255,184,0,0.05);border:1px solid rgba(255,184,0,0.3);border-radius:3px;padding:10px 13px;font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;color:var(--white);outline:none;text-align:center;margin-bottom:14px;}
.ninput::placeholder{color:var(--text-dim);}
.ninput:focus{border-color:var(--gold);box-shadow:0 0 14px rgba(255,184,0,0.2);}
.nenter{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:1px solid #ff7700;width:100%;font-size:17px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;padding:12px;border-radius:3px;cursor:pointer;}
.nenter:hover{background:linear-gradient(180deg,#ee6600,#aa3300);}

/* MYSTERY BOX */
.mbox-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.mbox-overlay.show{opacity:1;pointer-events:all;}
.mbox{background:var(--panel);border:2px solid rgba(138,43,226,0.5);border-radius:10px;padding:32px 36px;text-align:center;max-width:420px;width:92%;box-shadow:0 0 60px rgba(138,43,226,0.3);}
.mbox-icon{font-size:56px;margin-bottom:12px;animation:bounce .6s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-8px)}}
.mbox-title{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:4px;color:#cc88ff;margin-bottom:4px;}
.mbox-reward{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--gold);margin:10px 0;}
.mbox-desc{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-dim);line-height:1.7;margin-bottom:20px;}
.mbox-trigger{font-family:'Share Tech Mono',monospace;font-size:10px;color:#9955cc;letter-spacing:2px;margin-bottom:16px;}
.mbox-btn{background:linear-gradient(180deg,#6600cc,#440088);color:#fff;border:1px solid #aa44ff;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;padding:12px 40px;border-radius:4px;cursor:pointer;width:100%;}
.mbox-btn:hover{background:linear-gradient(180deg,#8800ff,#5500aa);}

/* REFERRAL MODAL */
.ref-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.ref-overlay.show{display:flex;animation:pgin .25s ease;}
.ref-modal{background:var(--panel);border:2px solid rgba(0,255,136,0.35);border-radius:8px;padding:28px 32px;max-width:440px;width:94%;box-shadow:0 0 50px rgba(0,255,136,0.15);text-align:center;}
.ref-modal-title{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:4px;color:var(--green);margin-bottom:6px;}
.ref-modal-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:18px;line-height:1.8;}
.ref-modal-sub span{color:var(--green);}
.ref-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.ref-stat{background:rgba(0,255,136,0.05);border:1px solid rgba(0,255,136,0.15);border-radius:4px;padding:10px;}
.ref-stat-val{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--green);}
.ref-stat-lbl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.ref-link-box{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--gold);background:rgba(0,0,0,0.5);border:1px solid rgba(0,255,136,0.25);border-radius:4px;padding:10px 14px;word-break:break-all;margin-bottom:10px;text-align:left;cursor:pointer;}
.ref-link-box:hover{border-color:rgba(0,255,136,0.5);}
.ref-modal-btns{display:flex;gap:8px;margin-bottom:14px;}
.ref-btn-copy{flex:1;background:linear-gradient(180deg,#006633,#003d1f);color:var(--green);border:1px solid rgba(0,255,136,0.4);font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:10px;border-radius:3px;cursor:pointer;}
.ref-btn-copy:hover{background:linear-gradient(180deg,#008844,#005522);}
.ref-btn-x{flex:1;background:rgba(255,255,255,0.04);color:#fff;border:1px solid rgba(255,255,255,0.15);font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:10px;border-radius:3px;cursor:pointer;}
.ref-btn-x:hover{background:rgba(255,255,255,0.1);}
.ref-rules{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.9;text-align:left;background:rgba(0,0,0,0.3);border-radius:4px;padding:10px 12px;margin-bottom:12px;}
.ref-rules span{color:var(--green);}
.ref-close{background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;padding:8px 24px;border-radius:3px;cursor:pointer;width:100%;}
.ref-close:hover{border-color:rgba(255,184,0,0.5);color:var(--gold);}
.ref-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,255,136,0.95);color:#000;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;padding:10px 24px;border-radius:4px;z-index:9999;display:none;}
.ref-toast.show{display:block;animation:fadeup .3s ease;}
@keyframes fadeup{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.lbrow.bot .lbnm{color:var(--text-dim);}

/* BANKRUPTCY OVERLAY */
.broke-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9998;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.broke-overlay.show{display:flex;animation:pgin .4s ease;}
.broke-box{background:var(--panel);border:2px solid rgba(255,34,0,0.5);border-radius:10px;padding:36px 38px;text-align:center;max-width:440px;width:94%;box-shadow:0 0 80px rgba(255,34,0,0.25);}
.broke-icon{font-size:64px;margin-bottom:10px;animation:shake .5s ease infinite alternate;}
@keyframes shake{from{transform:rotate(-6deg)}to{transform:rotate(6deg)}}
.broke-title{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:5px;color:var(--red-glow);filter:drop-shadow(0 0 20px rgba(255,51,0,0.8));margin-bottom:4px;}
.broke-sub{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.8;}
.broke-sub span{color:var(--red-glow);}
.broke-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:22px;}
.broke-stat{background:rgba(255,34,0,0.05);border:1px solid rgba(255,34,0,0.2);border-radius:4px;padding:10px 6px;}
.broke-stat-val{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--red-glow);}
.broke-stat-lbl{font-size:9px;color:var(--text-dim);letter-spacing:1px;}
.broke-btns{display:flex;flex-direction:column;gap:8px;}
.broke-claim-btn{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff7700;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;padding:14px;border-radius:4px;cursor:pointer;animation:npulse 1s ease infinite;}
.broke-claim-btn:hover{background:linear-gradient(180deg,#ee6600,#aa3300);}
.broke-share-btn{background:rgba(255,255,255,0.04);color:#fff;border:1px solid rgba(255,255,255,0.2);font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:11px;border-radius:4px;cursor:pointer;}
.broke-share-btn:hover{background:rgba(255,255,255,0.1);}
.broke-ref-btn{background:rgba(0,255,136,0.06);color:var(--green);border:1px solid rgba(0,255,136,0.3);font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;padding:10px;border-radius:4px;cursor:pointer;}
.broke-ref-btn:hover{background:rgba(0,255,136,0.12);}

/* ‚îÄ‚îÄ RACE MODE ‚îÄ‚îÄ */
.race-btn{position:fixed;bottom:20px;right:20px;background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff9900;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;padding:12px 22px;border-radius:4px;cursor:pointer;z-index:500;animation:npulse 2s ease infinite;box-shadow:0 4px 20px rgba(255,100,0,0.4);}
.race-btn:hover{transform:scale(1.05);}

/* RACE LOBBY */
.race-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.94);z-index:99999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.race-overlay.show{display:flex;animation:pgin .3s ease;}
.race-lobby{background:var(--panel);border:2px solid rgba(255,184,0,0.35);border-radius:8px;padding:28px 32px;max-width:680px;width:96%;max-height:90vh;overflow-y:auto;}
.race-lobby-title{font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:5px;color:var(--gold);text-align:center;margin-bottom:4px;}
.race-lobby-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);text-align:center;margin-bottom:20px;}
.race-tabs{display:flex;gap:6px;margin-bottom:18px;}
.race-tab{flex:1;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;padding:9px;border-radius:3px;cursor:pointer;border:1px solid rgba(255,184,0,0.2);background:transparent;color:var(--text-dim);}
.race-tab.active{background:rgba(255,184,0,0.1);border-color:var(--gold);color:var(--gold);}
.race-tab-content{display:none;}.race-tab-content.show{display:block;}

/* OPEN RACES LIST */
.race-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;max-height:280px;overflow-y:auto;}
.race-list::-webkit-scrollbar{width:3px;}
.race-list::-webkit-scrollbar-thumb{background:var(--gold-dim);}
.race-card{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.15);border-radius:4px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.race-card:hover{border-color:rgba(255,184,0,0.35);}
.race-card-info{flex:1;}
.race-card-host{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--white);}
.race-card-meta{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:2px;}
.race-card-bet{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--gold);}
.race-card-players{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--green);margin-top:2px;text-align:right;}
.race-join-btn{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:1px solid #ff7700;font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;padding:8px 18px;border-radius:3px;cursor:pointer;white-space:nowrap;}
.race-join-btn:hover{background:linear-gradient(180deg,#ee6600,#aa3300);}
.race-join-btn:disabled{opacity:0.4;cursor:not-allowed;}
.race-empty{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);text-align:center;padding:24px;}

/* CREATE RACE */
.race-create-form{display:flex;flex-direction:column;gap:10px;}
.race-form-label{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:2px;color:var(--text-dim);margin-bottom:3px;}
.race-bet-chips{display:flex;gap:8px;flex-wrap:wrap;}
.race-bet-chip{background:rgba(255,184,0,0.05);border:1px solid rgba(255,184,0,0.2);color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;padding:8px 16px;border-radius:3px;cursor:pointer;}
.race-bet-chip.sel{background:rgba(255,184,0,0.15);border-color:var(--gold);}
.race-create-btn{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff7700;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:3px;padding:13px;border-radius:4px;cursor:pointer;margin-top:6px;}
.race-create-btn:hover{background:linear-gradient(180deg,#ee6600,#aa3300);}
.race-quickmatch-btn{background:linear-gradient(180deg,#006633,#003d1f);color:var(--green);border:2px solid rgba(0,255,136,0.4);font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:3px;padding:13px;border-radius:4px;cursor:pointer;width:100%;margin-bottom:8px;}
.race-quickmatch-btn:hover{background:linear-gradient(180deg,#008844,#005522);}

/* RACE WAITING ROOM */
.race-waiting{text-align:center;}
.race-waiting-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;color:var(--gold);margin-bottom:6px;}
.race-waiting-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:20px;}
.race-players-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px;}
.race-player-slot{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.12);border-radius:4px;padding:14px;text-align:center;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.race-player-slot.filled{border-color:rgba(0,255,136,0.3);background:rgba(0,255,136,0.04);}
.race-player-slot.me{border-color:var(--gold);background:rgba(255,184,0,0.08);}
.race-player-name{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--white);}
.race-player-status{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:3px;}
.race-player-empty{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,184,0,0.2);letter-spacing:2px;}
.race-start-btn{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff7700;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;padding:14px 40px;border-radius:4px;cursor:pointer;animation:npulse 1s ease infinite;margin-bottom:10px;}
.race-start-btn:disabled{opacity:0.3;animation:none;cursor:not-allowed;}
.race-leave-btn{background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;padding:8px 20px;border-radius:3px;cursor:pointer;}

/* RACE GAME - live race bar at top */
.race-bar{background:rgba(0,0,0,0.8);border:1px solid rgba(255,184,0,0.2);border-radius:4px;padding:10px 14px;margin-bottom:10px;display:none;}
.race-bar.show{display:block;}
.race-bar-title{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;color:var(--gold);margin-bottom:8px;text-align:center;}
.race-players-live{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.race-player-live{background:rgba(255,184,0,0.04);border:1px solid rgba(255,184,0,0.12);border-radius:3px;padding:6px 10px;text-align:center;min-width:100px;}
.race-player-live.me-live{border-color:var(--gold);}
.race-player-live.done{border-color:rgba(0,255,136,0.3);}
.race-player-live.bust{border-color:rgba(255,51,0,0.3);}
.rpl-name{font-family:'Bebas Neue',sans-serif;font-size:13px;color:var(--white);}
.rpl-status{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;}
.rpl-score{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--gold);}

/* RACE RESULTS */
.race-results-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.race-results-overlay.show{display:flex;animation:pgin .4s ease;}
.race-results-box{background:var(--panel);border:2px solid rgba(255,184,0,0.4);border-radius:8px;padding:30px 34px;max-width:500px;width:95%;text-align:center;}
.race-results-title{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:5px;color:var(--gold);margin-bottom:16px;}
.race-results-list{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;}
.race-result-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:4px;border:1px solid rgba(255,184,0,0.12);}
.race-result-row.winner{background:rgba(0,255,136,0.08);border-color:rgba(0,255,136,0.35);}
.race-result-row.loser{background:rgba(255,51,0,0.05);border-color:rgba(255,51,0,0.2);}
.race-result-row.push{background:rgba(255,184,0,0.05);}
.rrname{font-family:'Bebas Neue',sans-serif;font-size:17px;}
.rrscore{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--text-dim);}
.rrpayout{font-family:'Bebas Neue',sans-serif;font-size:18px;}
.race-play-again-btn{background:linear-gradient(180deg,#cc5500,#882200);color:#fff5cc;border:2px solid #ff7700;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;padding:13px 40px;border-radius:4px;cursor:pointer;margin-right:8px;}
.race-close-btn{background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;padding:12px 24px;border-radius:3px;cursor:pointer;}
</style>
</head>
<body>

<!-- NAME OVERLAY -->
<div class="noverlay" id="nameOverlay">
  <div class="nbox">
    <div class="ntitle">LOBSTAR GAMES</div>
    <div class="nsub">ENTER YOUR X HANDLE TO PLAY</div>
    <input class="ninput" id="nameInput" placeholder="YOUR X HANDLE (e.g. @LobstarGames)" maxlength="16" autocomplete="off">
    <button class="nenter" onclick="enterGame()">ENTER THE GAME ‚òÖ</button>
  </div>
</div>

<header>
  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 20px 6px;border-bottom:1px solid rgba(255,184,0,0.12);">
    <a href="https://lobstargames.win" style="color:var(--text-dim);text-decoration:none;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;border:1px solid rgba(255,184,0,0.3);padding:7px 16px;border-radius:3px;background:rgba(255,184,0,0.04);">‚Üê HOME</a>
    <div style="text-align:center;">
      <div class="logo" style="font-size:clamp(26px,4vw,44px);line-height:1;">L‚òÖBSTAR</div>
      <div class="logo-sub" style="font-size:11px;letter-spacing:8px;margin-top:-2px;">GAMES</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
      <a href="https://x.com/i/communities/2026705678774178004" target="_blank" style="color:var(--text-dim);text-decoration:none;font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;border:1px solid rgba(255,184,0,0.3);padding:7px 14px;border-radius:3px;background:rgba(255,184,0,0.04);">ùïè @LOBSTARGAMES</a>
      <button onclick="openRefModal()" style="color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;border:1px solid rgba(0,255,136,0.4);padding:7px 14px;border-radius:3px;background:rgba(0,255,136,0.06);cursor:pointer;">üîó INVITE</button>
      <button onclick="shareScore()" style="color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;border:1px solid rgba(255,184,0,0.4);padding:7px 14px;border-radius:3px;background:rgba(255,184,0,0.08);cursor:pointer;">üì£ SHARE</button>
    </div>
  </div>
  <div class="ticker-bar">
    <div class="ticker-item">$LOBSTARGAMES <span class="tv" id="tkPrice">$0.0042</span> <span class="tup" id="tkChange">+18.4%</span></div>
    <div class="ticker-item">SUPPLY <span class="tv" id="tkSupply">1,000,000,000</span></div>
    <div class="ticker-item">BURNED <span class="tv tdn" id="tkBurned">0</span></div>
    <div class="ticker-item">PLAYERS <span class="tv">üî¥ LIVE</span></div>
    <div class="ticker-item">BLOCK <span class="tv" id="tkBlock">294180422</span></div>
  </div>
</header>

<div class="main-grid">
  <!-- LEFT -->
  <div class="col-left">
    <div class="panel" style="margin-bottom:10px">
      <div class="ph">TOKEN SUPPLY</div>
      <div class="srw">
        <div class="sring">
          <svg viewBox="0 0 120 120">
            <defs><linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#cc3300"/><stop offset="100%" style="stop-color:#FFB800"/></linearGradient></defs>
            <circle class="rb" cx="60" cy="60" r="52"/>
            <circle class="rf" id="ringCircle" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="0"/>
          </svg>
          <div class="rc"><div class="rv" id="ringPct">100%</div><div class="rl">REMAINING</div></div>
        </div>
        <div class="sstats">
          <div class="sbox"><div class="sv">1.00B</div><div class="sl">TOTAL</div></div>
          <div class="sbox"><div class="sv" id="statBurned" style="color:var(--red-glow)">0</div><div class="sl">BURNED </div></div>
          <div class="sbox"><div class="sv" id="statCirc">1.00B</div><div class="sl">CIRCULATING</div></div>
          <div class="sbox"><div class="sv" id="statHolders">147</div><div class="sl">HOLDERS</div></div>
        </div>
        <div class="bflash" id="burnFlash"></div>
      </div>
    </div>
    <div class="panel">
      <div class="ph">MY WALLET</div>
      <div class="pb">
        <div class="wbox">
          <div class="waddr" id="walletAddr">Loading...</div>
          <div class="wbal" id="walletBal">10,000</div>
          <div class="wsub">$LOBSTAR TOKENS</div>
        </div>
        <div class="srow">
          <div class="ms"><div class="msv" id="statWins">0</div><div class="msl">WINS</div></div>
          <div class="ms"><div class="msv" id="statLosses">0</div><div class="msl">LOSSES</div></div>
          <div class="ms"><div class="msv" id="statStreak">0</div><div class="msl">STREAK</div></div>
        </div>
        <div class="pts-box">
          <div class="pts-val" id="statPts">0</div>
          <div class="pts-lbl">‚òÖ TOTAL POINTS EARNED ‚òÖ</div>
        </div>
        <button class="btn-rst" onclick="resetWallet()">‚Ü∫ RESET WALLET (10,000 $LOBSTAR)</button>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="col-center">
    <div class="bjtable" id="bjTable">

      <!-- POST-GAME OVERLAY -->
      <div class="pgo" id="pgOverlay">
        <div class="pgr" id="pgResult"></div>
        <div class="pgd" id="pgDetail"></div>
        <button class="btn-next" onclick="newHand()">‚ñ∂ NEXT HAND</button>
        <div class="cdwrap">
          <div class="cdring">
            <svg viewBox="0 0 46 46" width="46" height="46">
              <circle class="cdbg" cx="23" cy="23" r="18"/>
              <circle class="cdfill" id="crFill" cx="23" cy="23" r="18"/>
            </svg>
            <div class="cdnum" id="crNum">5</div>
          </div>
          <div class="cdlbl">AUTO NEXT</div>
        </div>
      </div>

      <!-- DEALER -->
      <div class="dealer-zone">
        <div class="hand-label" style="text-align:center">‚óÜ DEALER'S HAND ‚óÜ</div>
        <div class="cards-row" id="dealerCards"></div>
        <div class="sbadge" id="dealerScore">‚Äî</div>
      </div>

      <div class="divider"></div>
      <div class="result-msg" id="resultMsg"></div>
      <div class="divider"></div>

      <!-- PLAYER HANDS (single or split) -->
      <div class="hands-area" id="handsArea">
        <div class="hand-col" id="hand0col">
          <div class="hand-label" id="hand0label">‚óÜ YOUR HAND ‚óÜ</div>
          <div class="cards-row" id="hand0cards"></div>
          <div class="sbadge" id="hand0score">‚Äî</div>
        </div>
      </div>

      <!-- BET -->
      <div class="bet-area">
        <div class="bet-label">SELECT BET AMOUNT</div>
        <div class="chips-row">
          <div class="chip c100" onclick="addBet(100)">100</div>
          <div class="chip c500" onclick="addBet(500)">500</div>
          <div class="chip c1k"  onclick="addBet(1000)">1K</div>
          <div class="chip c5k"  onclick="addBet(5000)">5K</div>
          <div class="chip c10k" onclick="addBet(10000)">10K</div>
          <div class="chip cclr" onclick="clearBet()">CLR</div>
        </div>
        <div class="cur-bet"><span>BET: </span><span id="betDisplay">0</span><span> $LOBSTAR</span></div>
      </div>

      <!-- ACTIONS -->
      <div class="act-row" id="actRow">
        <button class="btn bdeal" id="btnDeal"   onclick="dealHand()">DEAL ‚òÖ</button>
        <button class="btn bhit"  id="btnHit"    onclick="playerHit()"    disabled>HIT</button>
        <button class="btn bstand" id="btnStand" onclick="playerStand()"  disabled>STAND</button>
        <button class="btn bdbl"  id="btnDouble" onclick="playerDouble()" disabled>DOUBLE</button>
        <button class="btn bsplit" id="btnSplit" onclick="playerSplit()"  disabled>SPLIT</button>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-right">
    <div class="panel" style="margin-bottom:10px">
      <div class="ph">LEADERBOARD</div>
      <div class="pb" style="padding:7px">
        <div class="lbwrap"><div id="lbList"></div></div>
      </div>
    </div>
    <div class="panel">
      <div class="ph">TERMINAL</div>
      <div class="term" id="terminal"></div>
      <div class="tinput-row"><span class="tprompt">lobstar@casino:~$</span> <span class="tcursor"></span></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const TOTAL_SUPPLY = 1_000_000_000;
const START_BAL = 10_000;
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let playerName = '', balance = START_BAL, bet = 0, deck = [];
let dealerHand = [];
// Split support: hands[0] always main, hands[1] split hand
let hands = [[]]; // array of hands
let activeHand = 0; // which hand player is currently playing
let isSplit = false;
let handResults = []; // outcome per hand
let gameState = 'betting'; // betting | playing | done
let totalBurned = 0, totalPoints = 0, wins = 0, losses = 0, streak = 0, tokenPrice = 0.0042;
let cdTimer = null;

// Leaderboard via Supabase + bots

// ‚îÄ‚îÄ ENTER ‚îÄ‚îÄ
// enterGame injected below

document.getElementById('nameInput').addEventListener('keydown', e => { if(e.key==='Enter') enterGame(); });

// ‚îÄ‚îÄ DECK ‚îÄ‚îÄ
function buildDeck() {
  deck = [];
  for (let s of SUITS) for (let r of RANKS) deck.push({r,s});
  for (let i=deck.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
}
const draw = () => deck.pop();
function cv(c) { if(['J','Q','K'].includes(c.r)) return 10; if(c.r==='A') return 11; return parseInt(c.r); }
function total(h) { let t=0,a=0; for(let c of h){t+=cv(c);if(c.r==='A')a++;} while(t>21&&a>0){t-=10;a--;} return t; }
const isBJ = h => h.length===2 && total(h)===21;
const hStr = h => h.map(c=>c.r+c.s).join(' ');

// ‚îÄ‚îÄ CARD RENDER ‚îÄ‚îÄ
const cc = c => (c.s==='‚ô•'||c.s==='‚ô¶') ? 'red' : 'black';
function mkCard(c, hidden=false) {
  const el = document.createElement('div');
  if (hidden) { el.className='card facedown'; return el; }
  el.className = `card ${cc(c)}`;
  el.innerHTML = `<div class="ct">${c.r}<br>${c.s}</div><div class="cc">${c.s}</div><div class="cb">${c.r}<br>${c.s}</div>`;
  return el;
}
function renderHand(elId, hand, hideSecond=false) {
  const el = document.getElementById(elId);
  el.innerHTML = '';
  hand.forEach((c,i) => el.appendChild(mkCard(c, hideSecond && i===1)));
}
function setSB(id, val, extra='') {
  const el = document.getElementById(id);
  el.textContent = val; el.className = 'sbadge' + (extra?' '+extra:'');
  if (val > 21) el.className = 'sbadge bust';
  else if (val === 21 && !extra) el.className = 'sbadge bj';
}

// ‚îÄ‚îÄ BET ‚îÄ‚îÄ
function addBet(a) {
  if (gameState !== 'betting') return;
  if (bet + a > balance) { tlog('warn','Insufficient balance.'); return; }
  bet += a; updBet();
}
function clearBet() { if (gameState !== 'betting') return; bet = 0; updBet(); }
function updBet() { document.getElementById('betDisplay').textContent = bet.toLocaleString(); }

// ‚îÄ‚îÄ DEAL ‚îÄ‚îÄ
function dealHand() {
  if (bet < 100) { tlog('warn','Minimum bet is 100 $LOBSTAR'); return; }
  if (bet > balance) { tlog('warn','Insufficient balance'); return; }
  buildDeck();
  hands = [[draw(), draw()]];
  dealerHand = [draw(), draw()];
  isSplit = false; activeHand = 0; handResults = [];
  gameState = 'playing';
  balance -= bet;
  renderDealerHand(true);
  renderAllHands();
  setSB('dealerScore', cv(dealerHand[0]));
  setSB('hand0score', total(hands[0]));
  setBtns(false, true, true, true, canSplit(hands[0]));
  document.getElementById('resultMsg').textContent = '';
  const ps = total(hands[0]);
  tlog('info', `DEAL ‚Äî Your: ${hStr(hands[0])} (${ps}) | Dealer shows: ${dealerHand[0].r}${dealerHand[0].s}`);
  if (isBJ(hands[0])) setTimeout(() => { revealDealer(); endHand('blackjack',0); }, 400);
  updateUI();
}

// ‚îÄ‚îÄ CAN SPLIT ‚îÄ‚îÄ
function canSplit(h) {
  return h.length === 2 && cv(h[0]) === cv(h[1]) && !isSplit && balance >= bet;
}

// ‚îÄ‚îÄ HIT ‚îÄ‚îÄ
function playerHit() {
  const h = hands[activeHand];
  h.push(draw());
  renderAllHands();
  const t = total(h);
  setSB(`hand${activeHand}score`, t);
  tlog('info', `HIT [Hand ${activeHand+1}] ‚Äî ${hStr(h)} = ${t}`);
  if (t > 21) setTimeout(() => endHand('bust', activeHand), 300);
  else if (t === 21) setTimeout(() => advanceHand(), 400);
  // Disable split after hit
  document.getElementById('btnSplit').disabled = true;
  document.getElementById('btnDouble').disabled = true;
}

// ‚îÄ‚îÄ STAND ‚îÄ‚îÄ
async function playerStand() {
  tlog('info', `STAND [Hand ${activeHand+1}] ‚Äî ${total(hands[activeHand])}`);
  if (typeof raceState !== 'undefined' && raceState==='playing') await endRacePlaying();
  advanceHand();
}

// ‚îÄ‚îÄ DOUBLE ‚îÄ‚îÄ
function playerDouble() {
  if (bet > balance) { tlog('warn','Not enough to double'); return; }
  balance -= bet; bet *= 2; updBet(); updateUI();
  hands[activeHand].push(draw());
  renderAllHands();
  const t = total(hands[activeHand]);
  setSB(`hand${activeHand}score`, t);
  tlog('warn', `DOUBLE DOWN [Hand ${activeHand+1}] ‚Äî ${hStr(hands[activeHand])} = ${t} | Bet: ${bet.toLocaleString()}`);
  setTimeout(() => { if (t > 21) endHand('bust', activeHand); else advanceHand(); }, 400);
}

// ‚îÄ‚îÄ SPLIT ‚îÄ‚îÄ
function playerSplit() {
  if (!canSplit(hands[0])) return;
  isSplit = true;
  balance -= bet; // pay for second hand
  // Create two hands from the pair
  const c1 = hands[0][0], c2 = hands[0][1];
  hands = [[c1, draw()], [c2, draw()]];
  activeHand = 0;
  renderAllHands();
  setSB('hand0score', total(hands[0]));
  setSB('hand1score', total(hands[1]));
  tlog('warn', `SPLIT! Hand 1: ${hStr(hands[0])} | Hand 2: ${hStr(hands[1])}`);
  // Check immediate BJ on split aces
  const h0BJ = isBJ(hands[0]);
  setBtns(false, !h0BJ, !h0BJ, !h0BJ && balance>=bet*2, false);
  highlightActiveHand();
  if (h0BJ) { tlog('bj','Hand 1: BLACKJACK!'); setTimeout(() => advanceHand(), 600); }
}

// ‚îÄ‚îÄ ADVANCE HAND (after stand / bust / done) ‚îÄ‚îÄ
function advanceHand() {
  if (isSplit && activeHand === 0) {
    activeHand = 1;
    highlightActiveHand();
    const t = total(hands[1]);
    const h1BJ = isBJ(hands[1]);
    setBtns(false, !h1BJ, !h1BJ, false, false);
    if (h1BJ) { tlog('bj','Hand 2: BLACKJACK!'); setTimeout(() => { revealDealer(); runDealer(); }, 500); }
  } else {
    setBtns(false, false, false, false, false);
    revealDealer();
    runDealer();
  }
}

function highlightActiveHand() {
  if (!isSplit) return;
  document.getElementById('hand0col').className = activeHand===0 ? 'hand-col active-hand' : 'hand-col inactive-hand';
  document.getElementById('hand1col').className = activeHand===1 ? 'hand-col active-hand' : 'hand-col inactive-hand';
  document.getElementById('hand0label').className = activeHand===0 ? 'hand-label active' : 'hand-label';
  document.getElementById('hand1label').className = activeHand===1 ? 'hand-label active' : 'hand-label';
}

// ‚îÄ‚îÄ RENDER PLAYER HANDS ‚îÄ‚îÄ
function renderAllHands() {
  const area = document.getElementById('handsArea');
  if (!isSplit) {
    area.innerHTML = `
      <div class="hand-col" id="hand0col">
        <div class="hand-label" id="hand0label">‚óÜ YOUR HAND ‚óÜ</div>
        <div class="cards-row" id="hand0cards"></div>
        <div class="sbadge" id="hand0score">‚Äî</div>
      </div>`;
    renderHand('hand0cards', hands[0]);
    setSB('hand0score', total(hands[0]));
  } else {
    area.innerHTML = `
      <div class="hand-col" id="hand0col">
        <div class="hand-label" id="hand0label">‚óÜ HAND 1 ‚óÜ</div>
        <div class="cards-row" id="hand0cards"></div>
        <div class="sbadge" id="hand0score">‚Äî</div>
      </div>
      <div class="split-vs">VS</div>
      <div class="hand-col" id="hand1col">
        <div class="hand-label" id="hand1label">‚óÜ HAND 2 ‚óÜ</div>
        <div class="cards-row" id="hand1cards"></div>
        <div class="sbadge" id="hand1score">‚Äî</div>
      </div>`;
    renderHand('hand0cards', hands[0]);
    renderHand('hand1cards', hands[1]);
    setSB('hand0score', total(hands[0]));
    setSB('hand1score', total(hands[1]));
    highlightActiveHand();
  }
}

// ‚îÄ‚îÄ DEALER ‚îÄ‚îÄ
function renderDealerHand(hide=false) {
  renderHand('dealerCards', dealerHand, hide);
}
function revealDealer() {
  renderDealerHand(false);
  setSB('dealerScore', total(dealerHand));
}
function runDealer() {
  let ds = total(dealerHand);
  const step = () => {
    if (ds < 17) {
      dealerHand.push(draw());
      renderDealerHand(false);
      ds = total(dealerHand);
      setSB('dealerScore', ds);
      tlog('info', `DEALER hits ‚Äî ${hStr(dealerHand)} = ${ds}`);
      setTimeout(step, 600);
    } else {
      resolveAllHands(ds);
    }
  };
  step();
}

// ‚îÄ‚îÄ RESOLVE ‚îÄ‚îÄ
function resolveAllHands(ds) {
  if (!isSplit) {
    const ps = total(hands[0]);
    // Was already handled for bust/bj
    if (handResults[0]) { finishGame(); return; }
    if (ds > 21 || ps > ds) endHand('win', 0, ds);
    else if (ds === ps) endHand('push', 0, ds);
    else endHand('lose', 0, ds);
  } else {
    // Resolve both hands
    let pending = hands.length;
    hands.forEach((h, i) => {
      if (!handResults[i]) { // not already resolved
        const ps = total(h);
        if (ps > 21) handResults[i] = 'bust';
        else if (isBJ(h)) handResults[i] = 'blackjack';
        else if (ds > 21 || ps > ds) handResults[i] = 'win';
        else if (ds === ps) handResults[i] = 'push';
        else handResults[i] = 'lose';
      }
    });
    finishGame();
  }
}

// ‚îÄ‚îÄ END SINGLE HAND (bust/bj early) ‚îÄ‚îÄ
function endHand(outcome, handIdx, ds) {
  handResults[handIdx] = outcome;
  if (isSplit && handIdx === 0 && outcome === 'bust') {
    // continue to hand 2
    advanceHand();
    return;
  }
  if (!isSplit) finishGame();
}

// ‚îÄ‚îÄ FINISH GAME ‚îÄ‚îÄ
function finishGame() {
  gameState = 'done';
  setBtns(false,false,false,false,false);

  const ds = total(dealerHand);
  let totalWinAmt = 0, totalBurnAmt = 0, totalPtEarned = 0;
  let overallOutcome = 'lose';
  let splitDetails = [];

  const handBets = isSplit ? [bet, bet] : [bet];

  hands.forEach((h, i) => {
    const outcome = handResults[i] || 'lose';
    const hBet = handBets[i];
    let payout = 0, burnAmt = 0, ptEarned = 0, label = '';

    if (outcome === 'blackjack') {
      payout = Math.floor(hBet * 2.5);
      ptEarned = Math.floor(hBet * 1.5);
      burnAmt = Math.floor(hBet * 0.05);
      label = '‚òÖ BJ ‚òÖ';
      wins++;
    } else if (outcome === 'win') {
      payout = hBet * 2;
      ptEarned = hBet;
      burnAmt = Math.floor(hBet * 0.02);
      label = 'WIN';
      wins++;
    } else if (outcome === 'push') {
      payout = hBet;
      ptEarned = Math.floor(hBet * 0.1);
      label = 'PUSH';
    } else {
      burnAmt = hBet;
      ptEarned = Math.floor(hBet * 0.05);
      label = outcome === 'bust' ? 'BUST' : 'LOSS';
      losses++;
    }

    balance += payout;
    totalWinAmt += payout;
    totalBurnAmt += burnAmt;
    totalPtEarned += ptEarned;

    // Update hand score badge with outcome
    const badgeClass = (outcome==='win'||outcome==='blackjack') ? 'won' : (outcome==='lose'||outcome==='bust') ? 'lost' : 'push';
    setSB(`hand${i}score`, total(h) + (outcome==='bust'?' BUST':''), badgeClass);

    if (isSplit) splitDetails.push({label, payout, hBet});
  });

  // Streak
  const hadAnyWin = handResults.some(r => r==='win'||r==='blackjack');
  const hadAnyLoss = handResults.some(r => r==='lose'||r==='bust');
  if (hadAnyWin && !hadAnyLoss) { streak++; overallOutcome = handResults.includes('blackjack') ? 'blackjack' : 'win'; }
  else if (hadAnyLoss && !hadAnyWin) { streak = 0; overallOutcome = 'lose'; }
  else { overallOutcome = 'push'; }

  totalPoints += totalPtEarned;
  if (totalBurnAmt > 0) burnTokens(totalBurnAmt);
  updateLBPlayer(totalPtEarned);
  bet = 0; updBet(); updateUI();

  // Log
  if (isSplit) {
    splitDetails.forEach((d,i) => {
      tlog(d.label.includes('WIN')||d.label.includes('BJ') ? 'win' : d.label==='PUSH'?'info':'lose',
        `Hand ${i+1}: ${d.label} ‚Äî Payout: ${d.payout.toLocaleString()} $LOBSTAR`);
    });
  } else {
    const oc = handResults[0];
    if (oc==='blackjack') tlog('bj',`BLACKJACK! +${totalWinAmt.toLocaleString()} $LOBSTAR`);
    else if (oc==='win') tlog('twin',`WIN! +${totalWinAmt.toLocaleString()} $LOBSTAR | Streak: ${streak}`);
    else if (oc==='push') tlog('tinfo','PUSH ‚Äî bet returned.');
    else tlog('tlose',`${oc.toUpperCase()} ‚Äî ${totalBurnAmt.toLocaleString()} $LOBSTAR burned `);
  }

  // Bankruptcy
  if (balance < 100) {
    setTimeout(() => showBankruptcy(), 900);
  }

  // Win flash
  if (overallOutcome==='win'||overallOutcome==='blackjack') {
    document.getElementById('bjTable').classList.add('twin-flash');
    setTimeout(()=>document.getElementById('bjTable').classList.remove('twin-flash'),900);
  }

  // Show post-game overlay
  showPostGame(overallOutcome, totalWinAmt, totalPtEarned, totalBurnAmt, splitDetails);
}

// ‚îÄ‚îÄ POST-GAME OVERLAY ‚îÄ‚îÄ
function showPostGame(outcome, winAmt, pts, burnAmt, splitDetails) {
  const labels = {blackjack:'‚òÖ BLACKJACK! ‚òÖ', win:'‚úì YOU WIN!', lose:'‚úó DEALER WINS', bust:'‚úó BUST!', push:'‚ü≥ PUSH'};
  const classes = {blackjack:'pgr pgbj', win:'pgr pgwin', lose:'pgr pglose', bust:'pgr pglose', push:'pgr pgpush'};

  document.getElementById('pgResult').className = classes[outcome] || 'pgr pglose';
  document.getElementById('pgResult').textContent = labels[outcome] || outcome.toUpperCase();

  let detail = '';
  if (isSplit && splitDetails.length > 0) {
    detail += `<div class="split-results">`;
    splitDetails.forEach((d,i) => {
      const c = (d.label.includes('WIN')||d.label.includes('BJ')) ? 'style="color:var(--green)"' : d.label==='PUSH'?'style="color:var(--gold)"':'style="color:var(--red-glow)"';
      detail += `<div class="split-hand"><div ${c}>${d.label}</div><div class="amt">${d.payout.toLocaleString()} $LOBSTAR</div></div>`;
    });
    detail += `</div>`;
  } else {
    if (winAmt > 0) detail += `<span class="amt">+${winAmt.toLocaleString()} $LOBSTAR</span><br>`;
    if (burnAmt > 0 && (outcome==='lose'||outcome==='bust')) detail += `<span class="brn"> ${burnAmt.toLocaleString()} burned</span><br>`;
  }
  detail += `<span class="ptsclr">+${pts.toLocaleString()} POINTS EARNED</span>`;
  document.getElementById('pgDetail').innerHTML = detail;
  document.getElementById('pgOverlay').classList.add('show');
  startCountdown(5);
}

// ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ
function startCountdown(secs) {
  clearCountdown();
  let rem = secs;
  const fill = document.getElementById('crFill');
  const num = document.getElementById('crNum');
  const circ = 113.1;
  const tick = () => {
    num.textContent = rem;
    fill.style.strokeDashoffset = circ * (1 - rem/secs);
    if (rem <= 0) { clearCountdown(); newHand(); return; }
    rem--;
    cdTimer = setTimeout(tick, 1000);
  };
  tick();
}
function clearCountdown() { if(cdTimer){clearTimeout(cdTimer);cdTimer=null;} }

// ‚îÄ‚îÄ NEW HAND ‚îÄ‚îÄ
function newHand() {
  clearCountdown();
  hands=[[]]; isSplit=false; activeHand=0; handResults=[];
  gameState='betting'; bet=0; updBet();
  document.getElementById('pgOverlay').classList.remove('show');
  document.getElementById('dealerCards').innerHTML='';
  document.getElementById('resultMsg').textContent='';
  renderAllHands();
  setSB('dealerScore','‚Äî'); setSB('hand0score','‚Äî');
  setBtns(true,false,false,false,false);
  tlog('sys','‚îÄ‚îÄ‚îÄ New hand ready. Place your bet. ‚îÄ‚îÄ‚îÄ');
}

// ‚îÄ‚îÄ RESET WALLET ‚îÄ‚îÄ
function resetWallet() {
  if(!confirm('Reset wallet to 10,000 $LOBSTAR? Stats will be cleared.')) return;
  clearCountdown();
  document.getElementById('pgOverlay').classList.remove('show');
  balance=START_BAL; wins=0; losses=0; streak=0; totalPoints=0; bet=0;
  hands=[[]]; isSplit=false; activeHand=0; handResults=[];
  updBet(); updateUI();
  document.getElementById('dealerCards').innerHTML='';
  document.getElementById('resultMsg').textContent='';
  gameState='betting'; setBtns(true,false,false,false,false);
  tlog('warn','‚Ü∫ Wallet reset ‚Äî 10,000 $LOBSTAR reloaded. Stats cleared.');
}

// ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ
function setBtns(deal,hit,stand,dbl,split) {
  document.getElementById('btnDeal').disabled = !deal;
  document.getElementById('btnHit').disabled = !hit;
  document.getElementById('btnStand').disabled = !stand;
  document.getElementById('btnDouble').disabled = !dbl;
  document.getElementById('btnSplit').disabled = !split;
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function updateUI() {
  document.getElementById('walletBal').textContent = balance.toLocaleString();
  document.getElementById('statWins').textContent = wins;
  document.getElementById('statLosses').textContent = losses;
  document.getElementById('statStreak').textContent = streak;
  document.getElementById('statPts').textContent = totalPoints.toLocaleString();
}

function fmtN(n) { if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toLocaleString(); }

// ‚îÄ‚îÄ BURN ‚îÄ‚îÄ
function burnTokens(amt) {
  totalBurned += amt;
  const pct = ((TOTAL_SUPPLY - totalBurned) / TOTAL_SUPPLY) * 100;
  document.getElementById('ringCircle').style.strokeDashoffset = 326.73 * (1 - pct/100);
  document.getElementById('ringPct').textContent = pct.toFixed(2) + '%';
  document.getElementById('statBurned').textContent = fmtN(totalBurned);
  document.getElementById('statCirc').textContent = fmtN(TOTAL_SUPPLY - totalBurned);
  document.getElementById('tkBurned').textContent = fmtN(totalBurned);
  document.getElementById('tkSupply').textContent = fmtN(TOTAL_SUPPLY - totalBurned);
  const f = document.getElementById('burnFlash');
  f.textContent = ` BURNED ${amt.toLocaleString()} $LOBSTAR`; f.style.opacity=1;
  setTimeout(()=>f.style.opacity=0, 2200);
  tokenPrice *= (1 + amt/TOTAL_SUPPLY*15);
  document.getElementById('tkPrice').textContent = '$'+tokenPrice.toFixed(6);
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
// LB functions injected below


// ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ
function tlog(type, msg) {
  const t = document.getElementById('terminal');
  const l = document.createElement('div'); l.className='tl';
  const ts = new Date().toTimeString().slice(0,8);
  const cm = {sys:'tsys',win:'twin',lose:'tlose',burn:'tburn',info:'tinfo',warn:'twarn',bj:'tbj',twin:'twin',tinfo:'tinfo',tlose:'tlose'};
  l.innerHTML=`<span class="tts">[${ts}]</span><span class="${cm[type]||'tinfo'}">${msg}</span>`;
  t.appendChild(l); t.scrollTop=t.scrollHeight;
}

// ‚îÄ‚îÄ BOTS ‚îÄ‚îÄ
const botNames = ['SnipeKing','MoonCrab','DegenLord','ClawMaster','RedShell','SolanaShark'];
function startBots() {
  const acts = [
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];const w=Math.random()>.45;const a=(Math.floor(Math.random()*50)+5)*100;tlog(w?'win':'lose',`${n} ${w?'WIN':'LOSS'} ‚Äî ${a.toLocaleString()} $LOBSTAR`);if(!w){const b=Math.floor(a*.7);totalBurned+=b;document.getElementById('tkBurned').textContent=fmtN(totalBurned);tokenPrice*=(1+b/TOTAL_SUPPLY*8);document.getElementById('tkPrice').textContent='$'+tokenPrice.toFixed(6);}},
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];const a=(Math.floor(Math.random()*200)+10)*1000;tlog('burn',`${n} burned ${a.toLocaleString()} $LOBSTAR `);totalBurned+=a;document.getElementById('tkBurned').textContent=fmtN(totalBurned);},
    ()=>{const b=parseInt(document.getElementById('tkBlock').textContent.replace(/,/g,''))+1;document.getElementById('tkBlock').textContent=b.toLocaleString();tlog('sys',`Block ${b.toLocaleString()} confirmed`);},
    ()=>{const h=Math.max(100,parseInt(document.getElementById('statHolders').textContent)+Math.floor(Math.random()*3)-1);document.getElementById('statHolders').textContent=h;},
    ()=>{tlog('warn',`Large buy: ${(Math.floor(Math.random()*500)+100)*1000} $LOBSTAR`);},
    ()=>{const n=botNames[~~(Math.random()*botNames.length)];tlog('bj',`${n} hit BLACKJACK! `);},
  ];
  const run = ()=>{
    acts[~~(Math.random()*acts.length)]();
    const bot=leaderboard[~~(Math.random()*(leaderboard.length-1))];
    if(bot&&!bot.isMe){bot.pts+=Math.floor(Math.random()*900+100);renderLB();}
    setTimeout(run,1600+Math.random()*2400);
  };
  setTimeout(run,2000);
}

function startTicker() {
  setInterval(()=>{
    tokenPrice=Math.max(0.00001,tokenPrice*(1+(Math.random()-.48)*.8/100));
    document.getElementById('tkPrice').textContent='$'+tokenPrice.toFixed(6);
    const d=((tokenPrice-.0042)/.0042*100);
    const el=document.getElementById('tkChange');
    el.textContent=(d>=0?'+':'')+d.toFixed(1)+'%';
    el.className=d>=0?'tup':'tdn';
  },3000);
}


// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPA_URL = "https://mvakqyddivstvsbioptg.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo";

const TOP_BOTS = [
  {name:'SnipeKing',  pts:84200, burned:1820000, isBot:true},
  {name:'MoonCrab',   pts:71500, burned:1540000, isBot:true},
  {name:'DegenLord',  pts:65800, burned:1200000, isBot:true},
];
const MID_BOTS = [
  {name:'ClawMaster', pts:12300, burned:980000,  isBot:true},
  {name:'RedShell',   pts:9100,  burned:750000,  isBot:true},
  {name:'SolanaShark',pts:7700,  burned:640000,  isBot:true},
  {name:'RugnPull',   pts:5400,  burned:510000,  isBot:true},
  {name:'PumpWizard', pts:3900,  burned:340000,  isBot:true},
];
let realPlayers = [];

async function fetchRealPlayers() {
  try {
    const r = await fetch(`${SUPA_URL}/rest/v1/leaderboard?select=handle,pts,burned,wins,losses,games&order=pts.desc&limit=50`, {
      headers: {'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY}
    });
    if (r.ok) {
      const data = await r.json();
      realPlayers = data.map(p => ({name:p.handle, pts:p.pts, burned:p.burned||0, isReal:true}));
    }
  } catch(e) {}
  renderLB();
}

async function saveScore() {
  if (!playerName) return;
  const update = {pts:totalPoints, burned:totalBurned, wins:wins, losses:losses, games:wins+losses, updated_at:new Date().toISOString()};
  try {
    // Always PATCH first ‚Äî updates existing row
    await fetch(
      `${SUPA_URL}/rest/v1/leaderboard?handle=eq.${encodeURIComponent(playerName)}`,
      {method:'PATCH', headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=minimal'}, body:JSON.stringify(update)}
    );
    // Also POST with upsert ‚Äî handles case where row doesn't exist yet
    await fetch(`${SUPA_URL}/rest/v1/leaderboard`, {
      method:'POST',
      headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'resolution=merge-duplicates,return=minimal'},
      body:JSON.stringify({handle:playerName, ...update})
    });
  } catch(e) { console.log('saveScore error:', e); }
}

function growBotScores() {
  const maxReal = Math.max(0, totalPoints, ...realPlayers.map(p=>p.pts));
  if (maxReal > 0) {
    TOP_BOTS[0].pts = Math.max(TOP_BOTS[0].pts, maxReal + 15000 + Math.floor(Math.random()*2000));
    TOP_BOTS[1].pts = Math.max(TOP_BOTS[1].pts, maxReal + 8000  + Math.floor(Math.random()*1500));
    TOP_BOTS[2].pts = Math.max(TOP_BOTS[2].pts, maxReal + 3000  + Math.floor(Math.random()*1000));
  }
  TOP_BOTS[0].pts += Math.floor(Math.random()*400+100);
  TOP_BOTS[1].pts += Math.floor(Math.random()*300+80);
  TOP_BOTS[2].pts += Math.floor(Math.random()*200+60);
}

setInterval(() => { fetchRealPlayers(); growBotScores(); }, 30000);

// ‚îÄ‚îÄ ENTER ‚îÄ‚îÄ
async function enterGame() {
  const v = document.getElementById('nameInput').value.trim();
  if (!v) { document.getElementById('nameInput').focus(); return; }
  playerName = v.toUpperCase();
  localStorage.setItem('lobstar_handle', playerName);
  document.getElementById('nameOverlay').style.display = 'none';
  document.getElementById('walletAddr').textContent = '0x' + Array.from({length:8},()=>Math.floor(Math.random()*16).toString(16)).join('') + '...';
  try {
    const r = await fetch(`${SUPA_URL}/rest/v1/leaderboard?handle=eq.${encodeURIComponent(playerName)}&select=pts,burned,wins,losses,games`, {
      headers: {'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY}
    });
    const data = await r.json();
    if (data && data.length > 0) {
      const s = data[0];
      totalPoints=s.pts||0; totalBurned=s.burned||0; wins=s.wins||0; losses=s.losses||0;
      tlog('sys', `Welcome back, ${playerName}! Stats restored.`);
      tlog('info', `Points: ${totalPoints.toLocaleString()} | Wins: ${wins} | Losses: ${losses}`);
    } else {
      await registerReferral(true);
      tlog('sys', `Welcome, ${playerName}. The house always burns.`);
      tlog('info', `Wallet: ${START_BAL.toLocaleString()} $LOBSTAR loaded`);
    }
  } catch(e) {
    tlog('sys', `Welcome, ${playerName}. The house always burns.`);
  }
  tlog('warn', `Min bet: 100 | SPLIT available | Every loss burns supply`);
  document.getElementById('raceBtn').style.display = 'block';
  // Check if returning to an active race
  const activeRace = await getMyActiveRace();
  if (activeRace) {
    tlog('warn', `‚öîÔ∏è You have an active race! Click RACE MODE to rejoin.`);
    showRefToast('‚öîÔ∏è ACTIVE RACE ‚Äî CLICK RACE MODE!');
    // Flash the race button
    const btn = document.getElementById('raceBtn');
    btn.style.background = 'linear-gradient(180deg,#006633,#003d1f)';
    btn.style.border = '2px solid #00ff88';
    btn.style.color = '#00ff88';
    btn.textContent = '‚öîÔ∏è REJOIN RACE';
    setTimeout(() => {
      btn.style.background = '';
      btn.style.border = '';
      btn.style.color = '';
      btn.textContent = '‚öîÔ∏è RACE MODE';
    }, 5000);
  }
  renderLB(); fetchRealPlayers(); updateUI(); startTicker(); startBots();
}
document.getElementById('nameInput').addEventListener('keydown', e => { if(e.key==='Enter') enterGame(); });
const savedHandle = localStorage.getItem('lobstar_handle');
if (savedHandle) document.getElementById('nameInput').value = savedHandle;

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
function updateLBPlayer() { renderLB(); saveScore(); }
function renderLB() {
  growBotScores();
  const realNoMe = realPlayers.filter(p => p.name !== playerName);
  const fillCount = Math.max(0, 7 - realNoMe.length);
  const fillers = MID_BOTS.slice(0, fillCount);
  const mid = [...realNoMe, ...fillers].sort((a,b) => b.pts-a.pts);
  const meEntry = playerName ? [{name:playerName, pts:totalPoints, burned:totalBurned, isMe:true}] : [];
  const combined = [...mid, ...meEntry].sort((a,b) => b.pts-a.pts);
  const final = [...TOP_BOTS, ...combined];
  const el = document.getElementById('lbList'); el.innerHTML='';
  final.slice(0,12).forEach((p,i) => {
    const isTopBot = TOP_BOTS.some(b=>b.name===p.name);
    const row = document.createElement('div');
    row.className='lbrow'+(p.isMe?' me':'')+(isTopBot||p.isBot?' bot':'');
    const rc=i===0?'g':i===1?'s':i===2?'b':'';
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(i+1);
    const tag=p.isMe?' ‚óÄ':p.isReal?' üî¥':'';
    row.innerHTML=`<div class="lbrnk ${rc}">${medal}</div><div class="lbnm">${p.name}${tag}</div><div class="lbpt">${p.pts.toLocaleString()}</div><div class="lbbr">${fmtN(p.burned)}üî•</div>`;
    el.appendChild(row);
  });
}

// ‚îÄ‚îÄ MYSTERY BOX ‚îÄ‚îÄ
const MBOX_REWARDS = [
  {weight:40,icon:'ü¶û',title:'LOBSTAR STASH',reward:'1,000 $LOBSTARGAMES',desc:'Stay claw-some! You earned a token stash.',amount:1000},
  {weight:30,icon:'‚≠ê',title:'STAR REWARD',reward:'5,000 $LOBSTARGAMES',desc:'Shining bright! A bigger token drop incoming.',amount:5000},
  {weight:15,icon:'üî•',title:'BURN BONUS',reward:'10,000 $LOBSTARGAMES',desc:'You are on fire! Top tier token reward locked in.',amount:10000},
  {weight:10,icon:'üëë',title:'DEGEN ROYALE',reward:'25,000 $LOBSTARGAMES',desc:'The claw has chosen wisely. Legendary reward.',amount:25000},
  {weight:4,icon:'üíé',title:'DIAMOND CLAW',reward:'50,000 $LOBSTARGAMES',desc:'Ultra rare! You just won the biggest token stash.',amount:50000},
  {weight:1,icon:'üåô',title:'MOONSHOT',reward:'100,000 $LOBSTARGAMES',desc:'ONE IN A HUNDRED. The lobster gods have blessed you.',amount:100000},
];
function pickMboxReward() {
  const tot=MBOX_REWARDS.reduce((s,r)=>s+r.weight,0);
  let roll=Math.random()*tot;
  for(const r of MBOX_REWARDS){roll-=r.weight;if(roll<=0)return r;}
  return MBOX_REWARDS[0];
}
function triggerMbox(reason) {
  const reward=pickMboxReward();
  document.getElementById('mboxIcon').textContent=reward.icon;
  document.getElementById('mboxTrigger').textContent=reason.toUpperCase();
  document.getElementById('mboxReward').textContent=reward.reward;
  document.getElementById('mboxDesc').textContent=reward.desc;
  document.getElementById('mboxOverlay').classList.add('show');
}
function closeMbox() { document.getElementById('mboxOverlay').classList.remove('show'); }
function checkMboxTrigger() {
  if(streak===3) setTimeout(()=>triggerMbox('3 WIN STREAK!'),800);
  if(streak===5) setTimeout(()=>triggerMbox('5 WIN STREAK!'),800);
  if(totalPoints>=10000&&totalPoints-wins*100<10000) setTimeout(()=>triggerMbox('10,000 POINTS REACHED!'),800);
  if(totalPoints>=50000&&totalPoints-wins*100<50000) setTimeout(()=>triggerMbox('50,000 POINTS REACHED!'),800);
  if(totalPoints>=100000&&totalPoints-wins*100<100000) setTimeout(()=>triggerMbox('100,000 POINTS REACHED!'),800);
}
document.addEventListener('click',e=>{ if(e.target===document.getElementById('mboxOverlay'))closeMbox(); });

// ‚îÄ‚îÄ REFERRAL ‚îÄ‚îÄ
const REFERRAL_BONUS = 500;
let referredBy = null;
let myReferralCount = 0;
(function(){ const p=new URLSearchParams(window.location.search); const r=p.get('ref'); if(r)referredBy=r.toUpperCase(); })();

function getRefLink() {
  const base=window.location.origin+window.location.pathname;
  return `${base}?ref=${encodeURIComponent(playerName)}`;
}
function openRefModal() {
  document.getElementById('refOverlay').classList.add('show');
  if (playerName) {
    document.getElementById('refLinkBox').textContent = getRefLink();
    loadReferralCount();
  } else {
    document.getElementById('refLinkBox').textContent = 'Login first to get your invite link';
  }
}
function closeRefModal() { document.getElementById('refOverlay').classList.remove('show'); }
document.addEventListener('click',e=>{ if(e.target===document.getElementById('refOverlay'))closeRefModal(); });

function copyRefLink() {
  if(!playerName){showRefToast('LOGIN FIRST!');return;}
  navigator.clipboard.writeText(getRefLink()).then(()=>showRefToast('üîó LINK COPIED!'));
}
function shareRefOnX() {
  if(!playerName){showRefToast('LOGIN FIRST!');return;}
  const txt=encodeURIComponent('ü¶û Playing $LOBSTARGAMES ‚Äî crypto blackjack where every loss burns supply forever!\n\nJoin with my link and get +500 FREE chips üëá\n'+getRefLink());
  window.open('https://twitter.com/intent/tweet?text='+txt,'_blank');
}
function showRefToast(msg) {
  const t=document.getElementById('refToast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
async function loadReferralCount() {
  if(!playerName)return;
  try {
    const r=await fetch(`${SUPA_URL}/rest/v1/referrals?referrer=eq.${encodeURIComponent(playerName)}&select=id`,{headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY}});
    const data=await r.json();
    myReferralCount=Array.isArray(data)?data.length:0;
    document.getElementById('refCountVal').textContent=myReferralCount;
    document.getElementById('refBonusVal').textContent=(myReferralCount*REFERRAL_BONUS).toLocaleString();
  }catch(e){}
}
async function registerReferral(isNewPlayer) {
  if(!referredBy||!isNewPlayer||referredBy===playerName)return;
  try {
    const r=await fetch(`${SUPA_URL}/rest/v1/referrals`,{
      method:'POST',
      headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({referrer:referredBy,referred:playerName,bonus_paid:false})
    });
    if(r.ok||r.status===201) {
      balance+=REFERRAL_BONUS; updateUI();
      showRefToast(`üéÅ +${REFERRAL_BONUS} CHIPS from ${referredBy}!`);
      tlog('win',`Referred by ${referredBy} ‚Äî +${REFERRAL_BONUS} bonus chips!`);
    }
  }catch(e){}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ RACE MODE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRaceId = null;
let currentRaceBet = 500;
let currentRaceMax = 4;
let racePollingInterval = null;
let racePollInterval = null;
let raceRole = null;
let raceState = 'idle';

async function openRaceLobby() {
  if (!playerName) { showRefToast('LOGIN FIRST!'); return; }
  try {
    // Check if already in an active race
    const existing = await getMyActiveRace();
    if (existing) {
      const confirmLeave = confirm(`You are already in a race!\nLeave and open lobby?`);
      if (!confirmLeave) return;
      await leaveRace();
    }
    const el = document.getElementById('raceOverlay');
    el.classList.add('show'); el.style.display='flex';
    loadOpenRaces();
  } catch(e) { tlog('warn','openRaceLobby error: '+e.message); }
}

// Check if this player is already in a waiting/playing race
async function getMyActiveRace() {
  try {
    const r = await fetch(
      `${SUPA_URL}/rest/v1/race_hands?handle=eq.${encodeURIComponent(playerName)}&select=race_id,status`,
      {headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY}}
    );
    const hands = await r.json();
    if (!hands.length) return null;
    // Check if any of these races are still active
    for (const h of hands) {
      const rr = await fetch(
        `${SUPA_URL}/rest/v1/races?id=eq.${h.race_id}&select=id,status`,
        {headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY}}
      );
      const races = await rr.json();
      if (races.length && (races[0].status==='waiting'||races[0].status==='playing')) {
        return races[0];
      }
    }
  } catch(e) {}
  return null;
}
function closeRaceLobby() { document.getElementById('raceOverlay').classList.remove('show'); document.getElementById('raceOverlay').style.display='none'; }

function switchRaceTab(tab) {
  document.getElementById('tabFind').classList.toggle('active', tab==='find');
  document.getElementById('tabCreate').classList.toggle('active', tab==='create');
  document.getElementById('tabFindContent').classList.toggle('show', tab==='find');
  document.getElementById('tabCreateContent').classList.toggle('show', tab==='create');
}
function selectRaceBet(amt) {
  currentRaceBet = amt;
  [500,1000,2500,5000].forEach(a => { const el=document.getElementById('rbc'+a); if(el) el.classList.toggle('sel',a===amt); });
}
function selectRaceMax(n) {
  currentRaceMax = n;
  [2,4].forEach(a => { const el=document.getElementById('rmax'+a); if(el) el.classList.toggle('sel',a===n); });
}

async function loadOpenRaces() {
  const el = document.getElementById('raceList');
  el.innerHTML = '<div class="race-empty">Loading...</div>';
  try {
    const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?status=eq.waiting&select=id,bet,max_players,created_by,created_at`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const races = await r.json();
    if (!races.length) { el.innerHTML = '<div class="race-empty">No open races ‚Äî create one!</div>'; return; }
    el.innerHTML = '';
    for (const race of races) {
      const pr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${race.id}&select=handle`,
        {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
      const players = await pr.json();
      const count = players.length;
      const isFull = count >= race.max_players;
      const alreadyIn = players.some(p=>p.handle===playerName);
      const card = document.createElement('div');
      card.className = 'race-card';
      card.innerHTML = `<div class="race-card-info"><div class="race-card-host">üé≤ ${race.created_by}'s RACE</div><div class="race-card-meta">${new Date(race.created_at).toLocaleTimeString()}</div></div><div style="text-align:right"><div class="race-card-bet">${race.bet.toLocaleString()} $LOBSTAR</div><div class="race-card-players">${count}/${race.max_players} PLAYERS</div></div><button class="race-join-btn" ${isFull||alreadyIn?'disabled':''} onclick="joinRace('${race.id}',${race.bet})">${alreadyIn?'JOINED':isFull?'FULL':'JOIN'}</button>`;
      el.appendChild(card);
    }
  } catch(e) { el.innerHTML = '<div class="race-empty">Error loading. Try refresh.</div>'; tlog('warn','loadOpenRaces error: '+e.message); }
}

async function quickMatch() {
  if (balance < 500) { showRefToast('NEED 500+ CHIPS!'); return; }
  try {
    const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?status=eq.waiting&select=id,bet,max_players`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const races = await r.json();
    for (const race of races) {
      const pr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${race.id}&select=handle`,
        {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
      const players = await pr.json();
      if (players.length < race.max_players && !players.some(p=>p.handle===playerName)) {
        joinRace(race.id, race.bet); return;
      }
    }
  } catch(e) {}
  createRace();
}

async function createRace() {
  if (!playerName) { showRefToast('LOGIN FIRST!'); return; }
  if (balance < currentRaceBet) { showRefToast('NOT ENOUGH CHIPS!'); return; }
  // Block duplicate race creation
  const existingRace = await getMyActiveRace();
  if (existingRace) {
    tlog('warn', 'You already have an active race!');
    showRefToast('ALREADY IN A RACE!');
    return;
  }
  try {
    const deck = buildRaceDeck();
    const dealerCards = [deck.pop(), deck.pop()];
    const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races`, {
      method:'POST',
      headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=representation'},
      body:JSON.stringify({status:'waiting',bet:currentRaceBet,dealer_cards:JSON.stringify(dealerCards),max_players:currentRaceMax,created_by:playerName})
    });
    const data = await r.json();
    const raceId = data[0].id;
    await joinRaceAsPlayer(raceId);
    raceRole = 'host';
    closeRaceLobby();
    openWaitingRoom(raceId, currentRaceBet, currentRaceMax);
  } catch(e) { tlog('warn','Create race error: '+e.message); }
}

async function joinRace(raceId, bet) {
  if (!playerName) { showRefToast('LOGIN FIRST!'); return; }
  if (balance < bet) { showRefToast('NOT ENOUGH CHIPS!'); return; }
  // Block joining if already in a race
  const existingRace = await getMyActiveRace();
  if (existingRace) {
    if (existingRace.id === raceId) { showRefToast('ALREADY IN THIS RACE!'); return; }
    tlog('warn','Already in another race ‚Äî leave first.');
    showRefToast('LEAVE CURRENT RACE FIRST!');
    return;
  }
  currentRaceId = raceId;
  currentRaceBet = bet;
  await joinRaceAsPlayer(raceId);
  raceRole = 'joiner';
  closeRaceLobby();
  try {
    const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?id=eq.${raceId}&select=bet,max_players`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const data = await r.json();
    openWaitingRoom(raceId, data[0].bet, data[0].max_players);
  } catch(e) { openWaitingRoom(raceId, bet, 4); }
}

async function joinRaceAsPlayer(raceId) {
  currentRaceId = raceId;
  await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands`, {
    method:'POST',
    headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=minimal'},
    body:JSON.stringify({race_id:raceId,handle:playerName,status:'waiting',cards:'[]'})
  });
}

let autoStartTimer = null;
let autoStartSecs = 60;

function openWaitingRoom(raceId, bet, maxPlayers) {
  currentRaceId = raceId;
  document.getElementById('raceWaitBet').textContent = bet.toLocaleString();
  document.getElementById('raceWaitMax').textContent = maxPlayers;
  document.getElementById('raceWaitOverlay').classList.add('show');
  document.getElementById('raceWaitOverlay').style.display='flex';
  pollWaitingRoom();
  startAutoStartTimer(raceId);
}

function startAutoStartTimer(raceId) {
  clearInterval(autoStartTimer);
  autoStartSecs = 60;
  autoStartTimer = setInterval(async () => {
    autoStartSecs--;
    const el = document.getElementById('raceAutoTimer');
    if (el) el.textContent = autoStartSecs;
    if (autoStartSecs <= 0) {
      clearInterval(autoStartTimer);
      // Auto-start with whoever is in
      tlog('warn', '‚è± Auto-starting race with available players...');
      if (raceRole === 'host') {
        await startRace();
      } else {
        // Force race to start by patching status
        await fetch(`${SUPA_URL}/rest/v1/races?id=eq.${currentRaceId}`, {
          method:'PATCH',
          headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
          body:JSON.stringify({status:'playing', started_at:new Date().toISOString()})
        });
      }
    }
  }, 1000);
}

function pollWaitingRoom() {
  clearInterval(racePollingInterval);
  racePollingInterval = setInterval(async () => {
    if (!currentRaceId) return;
    try {
      const rr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?id=eq.${currentRaceId}&select=status,bet,max_players`,
        {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
      const rdata = await rr.json();
      if (!rdata.length) return;
      const race = rdata[0];
      const pr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&select=handle,status`,
        {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
      const players = await pr.json();
      updateWaitingRoomUI(players, race);
      if (race.status === 'playing') {
        clearInterval(racePollingInterval);
        document.getElementById('raceWaitOverlay').classList.remove('show'); document.getElementById('raceWaitOverlay').style.display='none';
        beginRacePlaying();
      }
    } catch(e) {}
  }, 2000);
}

function updateWaitingRoomUI(players, race) {
  const grid = document.getElementById('racePlayersGrid');
  grid.innerHTML = '';
  for (let i=0; i<race.max_players; i++) {
    const p = players[i];
    const isMe = p && p.handle === playerName;
    const slot = document.createElement('div');
    slot.className = 'race-player-slot'+(p?' filled':'')+(isMe?' me':'');
    slot.innerHTML = p ? `<div class="race-player-name">${isMe?'‚òÖ ':''}${p.handle}</div><div class="race-player-status">${isMe?'YOU':'READY'}</div>` : '<div class="race-player-empty">WAITING...</div>';
    grid.appendChild(slot);
  }
  const startBtn = document.getElementById('raceStartBtn');
  if (raceRole==='host') { startBtn.disabled = players.length < 2; startBtn.textContent = players.length>=2?'‚ñ∂ START RACE':'NEED 1 MORE PLAYER...'; }
  else { startBtn.textContent='WAITING FOR HOST...'; startBtn.disabled=true; }
}

async function startRace() {
  if (raceRole !== 'host') return;
  clearInterval(racePollingInterval);
  const pr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&select=handle`,
    {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
  const players = await pr.json();
  const deck = buildRaceDeck();
  for (const p of players) {
    const cards = [deck.pop(), deck.pop()];
    await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&handle=eq.${encodeURIComponent(p.handle)}`, {
      method:'PATCH',
      headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({cards:JSON.stringify(cards),status:'playing'})
    });
  }
  await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?id=eq.${currentRaceId}`, {
    method:'PATCH',
    headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=minimal'},
    body:JSON.stringify({status:'playing',started_at:new Date().toISOString()})
  });
  document.getElementById('raceWaitOverlay').classList.remove('show'); document.getElementById('raceWaitOverlay').style.display='none';
  beginRacePlaying();
}

async function beginRacePlaying() {
  raceState = 'playing';
  try {
    const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&handle=eq.${encodeURIComponent(playerName)}&select=cards`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const data = await r.json();
    if (!data.length) return;
    const myCards = JSON.parse(data[0].cards);
    if (balance < currentRaceBet) { tlog('warn','Not enough chips!'); leaveRace(); return; }
    balance -= currentRaceBet; bet = currentRaceBet; updateUI();
    buildDeck();
    hands=[myCards]; dealerHand=[]; isSplit=false; activeHand=0; handResults=[];
    gameState='playing';
    document.getElementById('raceBar').classList.add('show');
    renderAllHands();
    setSB('dealerScore','?'); setSB('hand0score',total(hands[0]));
    document.getElementById('dealerCards').innerHTML='';
    const fd=document.createElement('div'); fd.className='card facedown';
    document.getElementById('dealerCards').appendChild(fd);
    setBtns(false,true,true,balance>=currentRaceBet,false);
    tlog('sys','‚öîÔ∏è RACE STARTED! Beat the dealer. Winner takes all bets!');
    tlog('info',`Your hand: ${hStr(hands[0])} (${total(hands[0])})`);
    pollRacePlayers();
    if (isBJ(hands[0])) { tlog('bj','BLACKJACK in the race!'); await submitRaceHand('blackjack',total(hands[0])); setBtns(false,false,false,false,false); }
  } catch(e) { tlog('warn','Race start error: '+e); }
}

function pollRacePlayers() {
  clearInterval(racePollInterval);
  racePollInterval = setInterval(async () => {
    if (!currentRaceId||raceState==='idle') return;
    try {
      const r = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&select=handle,status,score`,
        {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
      const players = await r.json();
      updateRaceBar(players);
      const allDone = players.length>0 && players.every(p=>['done','bust','blackjack'].includes(p.status));
      if (allDone && raceState==='playing') { raceState='resolving'; clearInterval(racePollInterval); await resolveRace(); }
    } catch(e) {}
  }, 1500);
}

function updateRaceBar(players) {
  const el=document.getElementById('racePlayersLive'); el.innerHTML='';
  players.forEach(p => {
    const isMe=p.handle===playerName;
    const div=document.createElement('div');
    div.className='race-player-live'+(isMe?' me-live':'')+(['done','blackjack'].includes(p.status)?' done':p.status==='bust'?' bust':'');
    div.innerHTML=`<div class="rpl-name">${isMe?'‚òÖ ':''}${p.handle}</div><div class="rpl-score">${p.score||'?'}</div><div class="rpl-status">${p.status.toUpperCase()}</div>`;
    el.appendChild(div);
  });
}

async function endRacePlaying() {
  if (raceState!=='playing') return;
  const myScore=total(hands[0]);
  const myStatus=isBJ(hands[0])?'blackjack':myScore>21?'bust':'done';
  await submitRaceHand(myStatus,myScore);
  setBtns(false,false,false,false,false);
  tlog('info',`‚öîÔ∏è Locked in: ${myScore}. Waiting for others...`);
}

async function submitRaceHand(status, score) {
  await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&handle=eq.${encodeURIComponent(playerName)}`, {
    method:'PATCH',
    headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=minimal'},
    body:JSON.stringify({status:status,score:score,cards:JSON.stringify(hands[0])})
  });
}

async function resolveRace() {
  try {
    const rr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?id=eq.${currentRaceId}&select=dealer_cards,bet`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const rdata = await rr.json();
    const dealerCards = JSON.parse(rdata[0].dealer_cards);
    const raceBet = rdata[0].bet;
    dealerHand=dealerCards;
    const tmpDeck=buildRaceDeck();
    while(total(dealerHand)<17) dealerHand.push(tmpDeck.pop());
    const ds=total(dealerHand);
    revealDealer();
    tlog('info',`DEALER: ${hStr(dealerHand)} = ${ds}`);
    const pr = await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&select=handle,score,status`,
      {headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
    const players = await pr.json();
    const results = players.map(p => {
      let result,payout=0;
      if(p.status==='bust'){result='bust';}
      else if(p.status==='blackjack'&&ds!==21){result='blackjack';}
      else if(ds>21||(p.score>ds)){result='win';}
      else if(p.score===ds){result='push';payout=raceBet;}
      else{result='lose';}
      return{...p,result,payout};
    });
    const winners=results.filter(p=>p.result==='win'||p.result==='blackjack');
    const totalPot=raceBet*players.length;
    if(winners.length>0){
      const share=Math.floor(totalPot/winners.length);
      results.forEach(p=>{if(p.result==='win'||p.result==='blackjack')p.payout=share;else if(p.result==='push')p.payout=raceBet;else p.payout=0;});
    }
    const me=results.find(p=>p.handle===playerName);
    if(me){
      balance+=me.payout; updateUI();
      if(me.result==='win'||me.result==='blackjack'){wins++;streak++;tlog('twin',`‚öîÔ∏è RACE WIN! +${me.payout.toLocaleString()} $LOBSTAR`);}
      else if(me.result==='push'){tlog('tinfo','‚öîÔ∏è RACE PUSH ‚Äî bet returned');}
      else{losses++;streak=0;const burned=Math.floor(raceBet*0.8);burnTokens(burned);tlog('tlose',`‚öîÔ∏è RACE LOSS ‚Äî ${burned.toLocaleString()} burned`);}
      saveScore();
    }
    await fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/races?id=eq.${currentRaceId}`, {
      method:'PATCH',
      headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({status:'done',finished_at:new Date().toISOString()})
    });
    showRaceResults(results,ds,totalPot,winners.length,raceBet);
    raceState='done';
  } catch(e){ tlog('warn','Resolve error: '+e); }
}

function showRaceResults(results,dealerScore,totalPot,winnerCount,raceBet) {
  const me=results.find(p=>p.handle===playerName);
  const iWon=me&&(me.result==='win'||me.result==='blackjack');
  document.getElementById('raceResultsTitle').textContent=iWon?'üèÜ YOU WIN THE RACE!':'üíÄ RACE OVER';
  document.getElementById('raceResultsTitle').style.color=iWon?'var(--green)':'var(--red-glow)';
  const list=document.getElementById('raceResultsList');
  list.innerHTML=`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);text-align:center;margin-bottom:8px">DEALER: ${dealerScore} | POT: ${totalPot.toLocaleString()} | ${winnerCount} WINNER(S)</div>`;
  const sorted=[...results].sort((a,b)=>({'blackjack':0,'win':1,'push':2,'lose':3,'bust':4}[a.result]||3)-({'blackjack':0,'win':1,'push':2,'lose':3,'bust':4}[b.result]||3));
  sorted.forEach((p,i)=>{
    const isMe=p.handle===playerName;
    const isWin=p.result==='win'||p.result==='blackjack';
    const isPush=p.result==='push';
    const row=document.createElement('div');
    row.className='race-result-row '+(isWin?'winner':isPush?'push':'loser');
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    row.innerHTML=`<div class="rrname" style="color:${isWin?'var(--green)':isPush?'var(--gold)':'var(--red-glow)'}">${medal}${isMe?'‚òÖ ':''}${p.handle}</div><div class="rrscore">Score: ${p.score||'BUST'}</div><div class="rrpayout" style="color:${isWin?'var(--green)':isPush?'var(--gold)':'var(--red-glow)'}">${p.payout?'+'+p.payout.toLocaleString():'-'+raceBet.toLocaleString()}</div>`;
    list.appendChild(row);
  });
  document.getElementById('raceResultsOverlay').classList.add('show'); document.getElementById('raceResultsOverlay').style.display='flex';
}

function closeRaceResults() {
  document.getElementById('raceResultsOverlay').classList.remove('show'); document.getElementById('raceResultsOverlay').style.display='none';
  document.getElementById('raceBar').classList.remove('show');
  raceState='idle'; currentRaceId=null; raceRole=null;
  newHand();
}
function playAgainRace() { closeRaceResults(); setTimeout(()=>openRaceLobby(),300); }
function leaveRace() {
  clearInterval(racePollingInterval); clearInterval(racePollInterval); clearInterval(autoStartTimer);
  if(currentRaceId) fetch(`https://mvakqyddivstvsbioptg.supabase.co/rest/v1/race_hands?race_id=eq.${currentRaceId}&handle=eq.${encodeURIComponent(playerName)}`,{method:'DELETE',headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12YWtxeWRkaXZzdHZzYmlvcHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ4NjIsImV4cCI6MjA4NzYxMDg2Mn0.aYl2lm3b2us5Y6GCpDkBv2ggNte8FSx3EyofyLB5qTo'}});
  currentRaceId=null; raceRole=null; raceState='idle';
  document.getElementById('raceWaitOverlay').classList.remove('show'); document.getElementById('raceWaitOverlay').style.display='none';
  tlog('warn','Left the race.');
}

function buildRaceDeck() {
  const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'],ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const d=[];
  for(let s of suits)for(let r of ranks)d.push({r,s});
  for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}
  return d;
}

// playerStand race hook handled inside playerStand() directly

// ‚îÄ‚îÄ SHARE SCORE ‚îÄ‚îÄ
function shareScore() {
  const txt=encodeURIComponent('ü¶û Just played @LobstarGames!\n\nüèÜ Points: '+totalPoints.toLocaleString()+'\n‚úì Wins: '+wins+' | ‚úó Losses: '+losses+'\nüî• Burned: '+fmtN(totalBurned)+' $LOBSTARGAMES\n\nEvery loss burns supply forever.\nPlay now üëá\nlobstargames.win/game');
  window.open('https://twitter.com/intent/tweet?text='+txt,'_blank');
}

// Init
growBotScores();
setBtns(true,false,false,false,false);
renderLB();
</script>

<!-- MYSTERY BOX -->
<div class="mbox-overlay" id="mboxOverlay">
  <div class="mbox">
    <div class="mbox-icon" id="mboxIcon">üéÅ</div>
    <div class="mbox-title">MYSTERY BOX</div>
    <div class="mbox-trigger" id="mboxTrigger">TRIGGERED BY STREAK</div>
    <div class="mbox-reward" id="mboxReward">??? $LOBSTARGAMES</div>
    <div class="mbox-desc" id="mboxDesc">Loading your reward...</div>
    <button class="mbox-btn" onclick="closeMbox()">CLAIM REWARD ü¶û</button>
  </div>
</div>

<!-- REFERRAL MODAL -->
<div class="ref-overlay" id="refOverlay">
  <div class="ref-modal">
    <div class="ref-modal-title">üîó INVITE FRENS</div>
    <div class="ref-modal-sub">
      Share your link. Frens get <span>+500 chips</span> on first signup.<br>
      You earn <span>+1,000 pts</span> for every new player you bring.
    </div>
    <div class="ref-stats-grid">
      <div class="ref-stat"><div class="ref-stat-val" id="refCountVal">0</div><div class="ref-stat-lbl">FRENS REFERRED</div></div>
      <div class="ref-stat"><div class="ref-stat-val" id="refBonusVal">0</div><div class="ref-stat-lbl">BONUS CHIPS GIVEN</div></div>
    </div>
    <div class="ref-link-box" id="refLinkBox" onclick="copyRefLink()">Login to generate your link</div>
    <div class="ref-modal-btns">
      <button class="ref-btn-copy" onclick="copyRefLink()">üìã COPY LINK</button>
      <button class="ref-btn-x" onclick="shareRefOnX()">ùïè SHARE ON X</button>
    </div>
    <div class="ref-rules">
      <span>HOW IT WORKS:</span><br>
      ‚Ä¢ Share your link ‚Üí fren opens lobstargames.win/game?ref=YOU<br>
      ‚Ä¢ New players only ‚Äî existing accounts don't qualify<br>
      ‚Ä¢ No self-referrals ‚Ä¢ Each player can only be referred once
    </div>
    <button class="ref-close" onclick="closeRefModal()">CLOSE</button>
  </div>
</div>
<div class="ref-toast" id="refToast"></div>


<!-- BANKRUPTCY OVERLAY -->
<div class="broke-overlay" id="brokeOverlay">
  <div class="broke-box">
    <div class="broke-icon">ü¶û</div>
    <div class="broke-title">RUGGED.</div>
    <div class="broke-sub">
      The house won. Your wallet hit <span>zero</span>.<br>
      Every chip you lost was burned forever.<br>
      The supply is smaller. The lobster endures.
    </div>
    <div class="broke-stats">
      <div class="broke-stat">
        <div class="broke-stat-val" id="brokeTotalGames">0</div>
        <div class="broke-stat-lbl">GAMES</div>
      </div>
      <div class="broke-stat">
        <div class="broke-stat-val" id="brokeBurned">0</div>
        <div class="broke-stat-lbl">BURNED</div>
      </div>
      <div class="broke-stat">
        <div class="broke-stat-val" id="brokePts">0</div>
        <div class="broke-stat-lbl">POINTS</div>
      </div>
    </div>
    <div class="broke-btns">
      <button class="broke-claim-btn" onclick="claimAirdrop()">ü™Ç CLAIM AIRDROP ‚Äî 5,000 CHIPS</button>
      <button class="broke-share-btn" onclick="shareRugged()">ùïè SHARE "I GOT RUGGED BY @LOBSTARGAMES"</button>
      <button class="broke-ref-btn" onclick="closeBrokeAndOpenRef()">üîó REFER A FREN ‚Äî GET EXTRA 500 CHIPS</button>
    </div>
  </div>
</div>


<!-- RACE BUTTON (fixed bottom right) -->
<button class="race-btn" id="raceBtn" onclick="openRaceLobby()" style="display:none">‚öîÔ∏è RACE MODE</button>

<!-- RACE LOBBY OVERLAY -->
<div class="race-overlay" id="raceOverlay">
  <div class="race-lobby">
    <div class="race-lobby-title">‚öîÔ∏è RACE MODE</div>
    <div class="race-lobby-sub">Same dealer. First to beat the house wins everyone's bet.</div>

    <div class="race-tabs">
      <button class="race-tab active" onclick="switchRaceTab('find')" id="tabFind">FIND RACE</button>
      <button class="race-tab" onclick="switchRaceTab('create')" id="tabCreate">CREATE RACE</button>
    </div>

    <!-- FIND TAB -->
    <div class="race-tab-content show" id="tabFindContent">
      <button class="race-quickmatch-btn" onclick="quickMatch()">‚ö° QUICK MATCH ‚Äî JOIN ANY OPEN RACE</button>
      <div class="race-list" id="raceList">
        <div class="race-empty">Loading open races...</div>
      </div>
      <button onclick="loadOpenRaces()" style="width:100%;background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:2px;padding:7px;border-radius:3px;cursor:pointer;">‚Ü∫ REFRESH</button>
    </div>

    <!-- CREATE TAB -->
    <div class="race-tab-content" id="tabCreateContent">
      <div class="race-create-form">
        <div>
          <div class="race-form-label">SELECT BET AMOUNT</div>
          <div class="race-bet-chips" id="raceBetChips">
            <div class="race-bet-chip sel" onclick="selectRaceBet(500)" id="rbc500">500</div>
            <div class="race-bet-chip" onclick="selectRaceBet(1000)" id="rbc1000">1K</div>
            <div class="race-bet-chip" onclick="selectRaceBet(2500)" id="rbc2500">2.5K</div>
            <div class="race-bet-chip" onclick="selectRaceBet(5000)" id="rbc5000">5K</div>
          </div>
        </div>
        <div>
          <div class="race-form-label">MAX PLAYERS</div>
          <div class="race-bet-chips" id="raceMaxChips">
            <div class="race-bet-chip" onclick="selectRaceMax(2)" id="rmax2">1v1</div>
            <div class="race-bet-chip sel" onclick="selectRaceMax(4)" id="rmax4">4 PLAYERS</div>
          </div>
        </div>
        <button class="race-create-btn" onclick="createRace()">üöÄ CREATE RACE</button>
      </div>
    </div>

    <div style="margin-top:14px;text-align:center;">
      <button onclick="closeRaceLobby()" style="background:transparent;color:var(--text-dim);border:1px solid rgba(255,184,0,0.2);font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;padding:8px 24px;border-radius:3px;cursor:pointer;">CLOSE</button>
    </div>
  </div>
</div>

<!-- RACE WAITING ROOM -->
<div class="race-overlay" id="raceWaitOverlay">
  <div class="race-lobby">
    <div class="race-waiting">
      <div class="race-waiting-title">‚è≥ WAITING FOR PLAYERS</div>
      <div class="race-waiting-sub" id="raceWaitSub">Auto-starts when full or in <span id="raceAutoTimer" style="color:var(--gold)">60</span>s</div>
      <div class="race-players-grid" id="racePlayersGrid"></div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:14px;">
        BET: <span style="color:var(--gold)" id="raceWaitBet">‚Äî</span> &bull; MAX: <span id="raceWaitMax">4</span> PLAYERS
      </div>
      <button class="race-start-btn" id="raceStartBtn" onclick="startRace()" disabled>‚ñ∂ START RACE</button><br>
      <button class="race-leave-btn" onclick="leaveRace()">LEAVE RACE</button>
    </div>
  </div>
</div>

<!-- RACE LIVE BAR (inside game, above dealer) -->
<div class="race-bar" id="raceBar">
  <div class="race-bar-title">‚öîÔ∏è RACE IN PROGRESS</div>
  <div class="race-players-live" id="racePlayersLive"></div>
</div>

<!-- RACE RESULTS -->
<div class="race-results-overlay" id="raceResultsOverlay">
  <div class="race-results-box">
    <div class="race-results-title" id="raceResultsTitle">RACE OVER!</div>
    <div class="race-results-list" id="raceResultsList"></div>
    <div>
      <button class="race-play-again-btn" onclick="playAgainRace()">‚ñ∂ PLAY AGAIN</button>
      <button class="race-close-btn" onclick="closeRaceResults()">CLOSE</button>
    </div>
  </div>
</div>

</body>
</html>
